- ğŸ‘‹ Hi, Iâ€™m @HermanGoGoGo
- ğŸ‘€ Iâ€™m interested in ...
- ğŸŒ± Iâ€™m currently learning ...
- ğŸ’ï¸ Iâ€™m looking to collaborate on ...
- ğŸ“« How to reach me ...

<!---
HermanGoGoGo/HermanGoGoGo is a âœ¨ special âœ¨ repository because its `README.md` (this file) appears on your GitHub profile.
You can click the Preview link to take a look at your changes.
--->
# ç¬¬äºŒç« ï¼šRedisé«˜çº§

## å­¦ä¹ ç›®æ ‡

ç›®æ ‡1ï¼šèƒ½å¤Ÿè¯´å‡ºredisä¸­çš„æ•°æ®åˆ é™¤ç­–ä¸ç•¥æ·˜æ±°ç­–ç•¥

ç›®æ ‡2ï¼šèƒ½å¤Ÿè¯´å‡ºä¸»ä»å¤åˆ¶çš„æ¦‚å¿µï¼Œå·¥ä½œæµç¨‹ä»¥åŠåœºæ™¯é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

ç›®æ ‡3ï¼šèƒ½å¤Ÿè¯´å‡ºå“¨å…µçš„ä½œç”¨ä»¥åŠå·¥ä½œåŸç†ï¼Œä»¥åŠå¦‚ä½•å¯ç”¨å“¨å…µ

ç›®æ ‡4ï¼šèƒ½å¤Ÿè¯´å‡ºé›†ç¾¤çš„æ¶æ„è®¾è®¡ï¼Œå®Œæˆé›†ç¾¤çš„æ­å»º

ç›®æ ‡5ï¼šèƒ½å¤Ÿè¯´å‡ºç¼“å­˜é¢„çƒ­ï¼Œé›ªå´©ï¼Œå‡»ç©¿ï¼Œç©¿é€çš„æ¦‚å¿µï¼Œèƒ½è¯´å‡ºredisçš„ç›¸å…³ç›‘æ§æŒ‡æ ‡

## 1.æ•°æ®åˆ é™¤ä¸æ·˜æ±°ç­–ç•¥

### 1.1 è¿‡æœŸæ•°æ®

#### **1.1.1 Redisä¸­çš„æ•°æ®ç‰¹å¾**

Redisæ˜¯ä¸€ç§å†…å­˜çº§æ•°æ®åº“ï¼Œæ‰€æœ‰æ•°æ®å‡å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜ä¸­çš„æ•°æ®å¯ä»¥é€šè¿‡TTLæŒ‡ä»¤è·å–å…¶çŠ¶æ€

TTLè¿”å›çš„å€¼æœ‰ä¸‰ç§æƒ…å†µï¼šæ­£æ•°ï¼Œ-1ï¼Œ-2

- **æ­£æ•°**ï¼šä»£è¡¨è¯¥æ•°æ®åœ¨å†…å­˜ä¸­è¿˜èƒ½å­˜æ´»çš„æ—¶é—´
- **-1**ï¼šæ°¸ä¹…æœ‰æ•ˆçš„æ•°æ®
- **2** ï¼šå·²ç»è¿‡æœŸçš„æ•°æ® æˆ–è¢«åˆ é™¤çš„æ•°æ® æˆ– æœªå®šä¹‰çš„æ•°æ®

**åˆ é™¤ç­–ç•¥å°±æ˜¯é’ˆå¯¹å·²è¿‡æœŸæ•°æ®çš„å¤„ç†ç­–ç•¥**ï¼Œå·²è¿‡æœŸçš„æ•°æ®æ˜¯çœŸçš„å°±ç«‹å³åˆ é™¤äº†å—ï¼Ÿå…¶å®ä¹Ÿä¸æ˜¯ï¼Œæˆ‘ä»¬ä¼šæœ‰å¤šç§åˆ é™¤ç­–ç•¥ï¼Œæ˜¯åˆ†æƒ…å†µçš„ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„åˆ é™¤æ–¹å¼ä¼šæœ‰ä¸åŒæ•ˆæœï¼Œè¿™ä¹Ÿæ­£æ˜¯æˆ‘ä»¬è¦å°†çš„æ•°æ®çš„åˆ é™¤ç­–ç•¥çš„é—®é¢˜

#### 1.1.2 æ—¶æ•ˆæ€§æ•°æ®çš„å­˜å‚¨ç»“æ„

åœ¨Redisä¸­ï¼Œå¦‚ä½•ç»™æ•°æ®è®¾ç½®å®ƒçš„å¤±æ•ˆå‘¨æœŸå‘¢ï¼Ÿæ•°æ®çš„æ—¶æ•ˆåœ¨redisä¸­å¦‚ä½•å­˜å‚¨å‘¢ï¼Ÿçœ‹ä¸‹å›¾ï¼š

![](./img/1.png)

è¿‡æœŸæ•°æ®æ˜¯ä¸€å—ç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´ï¼ŒHashç»“æ„ï¼Œfieldæ˜¯å†…å­˜åœ°å€ï¼Œvalueæ˜¯è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜äº†æ‰€æœ‰keyçš„è¿‡æœŸæè¿°ï¼Œåœ¨æœ€ç»ˆè¿›è¡Œè¿‡æœŸå¤„ç†çš„æ—¶å€™ï¼Œå¯¹è¯¥ç©ºé—´çš„æ•°æ®è¿›è¡Œæ£€æµ‹ï¼Œ å½“æ—¶é—´åˆ°æœŸä¹‹åé€šè¿‡fieldæ‰¾åˆ°å†…å­˜è¯¥åœ°å€å¤„çš„æ•°æ®ï¼Œç„¶åè¿›è¡Œç›¸å…³æ“ä½œã€‚

### 1.2 æ•°æ®åˆ é™¤ç­–ç•¥

#### 1.2.1 æ•°æ®åˆ é™¤ç­–ç•¥çš„ç›®æ ‡

åœ¨å†…å­˜å ç”¨ä¸CPUå ç”¨ä¹‹é—´å¯»æ‰¾ä¸€ç§å¹³è¡¡ï¼Œé¡¾æ­¤å¤±å½¼éƒ½ä¼šé€ æˆæ•´ä½“redisæ€§èƒ½çš„ä¸‹é™ï¼Œç”šè‡³å¼•å‘æœåŠ¡å™¨å®•æœºæˆ– å†…å­˜æ³„éœ²

é’ˆå¯¹è¿‡æœŸæ•°æ®è¦è¿›è¡Œåˆ é™¤çš„æ—¶å€™éƒ½æœ‰å“ªäº›åˆ é™¤ç­–ç•¥å‘¢ï¼Ÿ

- 1.å®šæ—¶åˆ é™¤
- 2.æƒ°æ€§åˆ é™¤
- 3.å®šæœŸåˆ é™¤

#### 1.2.2 å®šæ—¶åˆ é™¤

åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“keyè®¾ç½®æœ‰è¿‡æœŸæ—¶é—´ï¼Œä¸”è¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶ï¼Œç”±å®šæ—¶å™¨ä»»åŠ¡ç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ

- **ä¼˜ç‚¹**ï¼šèŠ‚çº¦å†…å­˜ï¼Œåˆ°æ—¶å°±åˆ é™¤ï¼Œå¿«é€Ÿé‡Šæ”¾æ‰ä¸å¿…è¦çš„å†…å­˜å ç”¨
- **ç¼ºç‚¹**ï¼šCPUå‹åŠ›å¾ˆå¤§ï¼Œæ— è®ºCPUæ­¤æ—¶è´Ÿè½½é‡å¤šé«˜ï¼Œå‡å ç”¨CPUï¼Œä¼šå½±å“redisæœåŠ¡å™¨å“åº”æ—¶é—´å’ŒæŒ‡ä»¤ååé‡
- **æ€»ç»“**ï¼šç”¨å¤„ç†å™¨æ€§èƒ½æ¢å–å­˜å‚¨ç©ºé—´ï¼ˆæ‹¿æ—¶é—´æ¢ç©ºé—´ï¼‰

![](./img/2.png)

#### 1.2.3 æƒ°æ€§åˆ é™¤

æ•°æ®åˆ°è¾¾è¿‡æœŸæ—¶é—´ï¼Œä¸åšå¤„ç†ã€‚ç­‰ä¸‹æ¬¡è®¿é—®è¯¥æ•°æ®æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­

1. å¦‚æœæœªè¿‡æœŸï¼Œè¿”å›æ•°æ®
2. å‘ç°å·²è¿‡æœŸï¼Œåˆ é™¤ï¼Œè¿”å›ä¸å­˜åœ¨

- **ä¼˜ç‚¹**ï¼šèŠ‚çº¦CPUæ€§èƒ½ï¼Œå‘ç°å¿…é¡»åˆ é™¤çš„æ—¶å€™æ‰åˆ é™¤
- **ç¼ºç‚¹**ï¼šå†…å­˜å‹åŠ›å¾ˆå¤§ï¼Œå‡ºç°é•¿æœŸå ç”¨å†…å­˜çš„æ•°æ®
- **æ€»ç»“**ï¼šç”¨å­˜å‚¨ç©ºé—´æ¢å–å¤„ç†å™¨æ€§èƒ½ï¼ˆæ‹¿æ—¶é—´æ¢ç©ºé—´ï¼‰

![](./img/3.png)

#### 1.2.4 å®šæœŸåˆ é™¤

å®šæ—¶åˆ é™¤å’Œæƒ°æ€§åˆ é™¤è¿™ä¸¤ç§æ–¹æ¡ˆéƒ½æ˜¯èµ°çš„æç«¯ï¼Œé‚£æœ‰æ²¡æœ‰æŠ˜ä¸­æ–¹æ¡ˆï¼Ÿ

æˆ‘ä»¬æ¥è®²redisçš„å®šæœŸåˆ é™¤æ–¹æ¡ˆï¼š

- Rediså¯åŠ¨æœåŠ¡å™¨åˆå§‹åŒ–æ—¶ï¼Œè¯»å–é…ç½®server.hzçš„å€¼ï¼Œé»˜è®¤ä¸º10

- æ¯ç§’é’Ÿæ‰§è¡Œserver.hzæ¬¡**serverCron()**-------->**databasesCron()**--------->**activeExpireCycle()**

- **activeExpireCycle()**å¯¹æ¯ä¸ªexpires[*]é€ä¸€è¿›è¡Œæ£€æµ‹ï¼Œæ¯æ¬¡æ‰§è¡Œè€—æ—¶ï¼š250ms/server.hz

- å¯¹æŸä¸ªexpires[*]æ£€æµ‹æ—¶ï¼ŒéšæœºæŒ‘é€‰Wä¸ªkeyæ£€æµ‹

```markdown
  å¦‚æœkeyè¶…æ—¶ï¼Œåˆ é™¤key

  å¦‚æœä¸€è½®ä¸­åˆ é™¤çš„keyçš„æ•°é‡>W*25%ï¼Œå¾ªç¯è¯¥è¿‡ç¨‹

  å¦‚æœä¸€è½®ä¸­åˆ é™¤çš„keyçš„æ•°é‡â‰¤W*25%ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ªexpires[*]ï¼Œ0-15å¾ªç¯

  Wå–å€¼=ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOPå±æ€§å€¼
```

- å‚æ•°current_dbç”¨äºè®°å½•**activeExpireCycle()** è¿›å…¥å“ªä¸ªexpires[*] æ‰§è¡Œ

- å¦‚æœactiveExpireCycle()æ‰§è¡Œæ—¶é—´åˆ°æœŸï¼Œä¸‹æ¬¡ä»current_dbç»§ç»­å‘ä¸‹æ‰§è¡Œ


![](./img/4.png)

æ€»çš„æ¥è¯´ï¼šå®šæœŸåˆ é™¤å°±æ˜¯å‘¨æœŸæ€§è½®è¯¢redisåº“ä¸­çš„æ—¶æ•ˆæ€§æ•°æ®ï¼Œé‡‡ç”¨éšæœºæŠ½å–çš„ç­–ç•¥ï¼Œåˆ©ç”¨è¿‡æœŸæ•°æ®å æ¯”çš„æ–¹å¼æ§åˆ¶åˆ é™¤é¢‘åº¦

- **ç‰¹ç‚¹1**ï¼šCPUæ€§èƒ½å ç”¨è®¾ç½®æœ‰å³°å€¼ï¼Œæ£€æµ‹é¢‘åº¦å¯è‡ªå®šä¹‰è®¾ç½®
- **ç‰¹ç‚¹2**ï¼šå†…å­˜å‹åŠ›ä¸æ˜¯å¾ˆå¤§ï¼Œé•¿æœŸå ç”¨å†…å­˜çš„å†·æ•°æ®ä¼šè¢«æŒç»­æ¸…ç†
- **æ€»ç»“**ï¼šå‘¨æœŸæ€§æŠ½æŸ¥å­˜å‚¨ç©ºé—´ï¼ˆéšæœºæŠ½æŸ¥ï¼Œé‡ç‚¹æŠ½æŸ¥ï¼‰

#### 1.2.5 åˆ é™¤ç­–ç•¥å¯¹æ¯”

1ï¼šå®šæ—¶åˆ é™¤ï¼š

```markdown
èŠ‚çº¦å†…å­˜ï¼Œæ— å ç”¨,
ä¸åˆ†æ—¶æ®µå ç”¨CPUèµ„æºï¼Œé¢‘åº¦é«˜,
æ‹¿æ—¶é—´æ¢ç©ºé—´
```

2ï¼šæƒ°æ€§åˆ é™¤ï¼š

```markdown
å†…å­˜å ç”¨ä¸¥é‡
å»¶æ—¶æ‰§è¡Œï¼ŒCPUåˆ©ç”¨ç‡é«˜
æ‹¿ç©ºé—´æ¢æ—¶é—´
```

3ï¼šå®šæœŸåˆ é™¤ï¼š

```markdown
å†…å­˜å®šæœŸéšæœºæ¸…ç†
æ¯ç§’èŠ±è´¹å›ºå®šçš„CPUèµ„æºç»´æŠ¤å†…å­˜
éšæœºæŠ½æŸ¥ï¼Œé‡ç‚¹æŠ½æŸ¥
```

### 1.3 æ•°æ®æ·˜æ±°ç­–ç•¥ï¼ˆé€å‡ºç®—æ³•ï¼‰

#### 1.3.1 æ·˜æ±°ç­–ç•¥æ¦‚è¿°

ä»€ä¹ˆå«æ•°æ®æ·˜æ±°ç­–ç•¥ï¼Ÿä»€ä¹ˆæ ·çš„åº”ç”¨åœºæ™¯éœ€è¦ç”¨åˆ°æ•°æ®æ·˜æ±°ç­–ç•¥ï¼Ÿ

å½“æ–°æ•°æ®è¿›å…¥redisæ—¶ï¼Œå¦‚æœå†…å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿåœ¨æ‰§è¡Œæ¯ä¸€ä¸ªå‘½ä»¤å‰ï¼Œä¼šè°ƒç”¨**freeMemoryIfNeeded()**æ£€æµ‹å†…å­˜æ˜¯å¦å……è¶³ã€‚å¦‚æœå†…å­˜ä¸æ»¡è¶³æ–° åŠ å…¥æ•°æ®çš„æœ€ä½å­˜å‚¨è¦æ±‚ï¼Œredisè¦ä¸´æ—¶åˆ é™¤ä¸€äº›æ•°æ®ä¸ºå½“å‰æŒ‡ä»¤æ¸…ç†å­˜å‚¨ç©ºé—´ã€‚æ¸…ç†æ•°æ®çš„ç­–ç•¥ç§°ä¸ºé€å‡ºç®—æ³•ã€‚

æ³¨æ„ï¼šé€å‡ºæ•°æ®çš„è¿‡ç¨‹ä¸æ˜¯100%èƒ½å¤Ÿæ¸…ç†å‡ºè¶³å¤Ÿçš„å¯ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœä¸æˆåŠŸåˆ™åå¤æ‰§è¡Œã€‚å½“å¯¹æ‰€æœ‰æ•°æ®å°è¯•å®Œæ¯•ï¼Œ  å¦‚ä¸èƒ½è¾¾åˆ°å†…å­˜æ¸…ç†çš„è¦æ±‚ï¼Œå°†å‡ºç°é”™è¯¯ä¿¡æ¯å¦‚ä¸‹

```shell
(error) OOM command not allowed when used memory >'maxmemory'
```

#### 1.3.2 ç­–ç•¥é…ç½®

å½±å“æ•°æ®æ·˜æ±°çš„ç›¸å…³é…ç½®å¦‚ä¸‹ï¼š

1ï¼šæœ€å¤§å¯ä½¿ç”¨å†…å­˜ï¼Œå³å ç”¨ç‰©ç†å†…å­˜çš„æ¯”ä¾‹ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œè¡¨ç¤ºä¸é™åˆ¶ã€‚ç”Ÿäº§ç¯å¢ƒä¸­æ ¹æ®éœ€æ±‚è®¾å®šï¼Œé€šå¸¸è®¾ç½®åœ¨50%ä»¥ä¸Š

```properties
maxmemory ?mb
```

2ï¼šæ¯æ¬¡é€‰å–å¾…åˆ é™¤æ•°æ®çš„ä¸ªæ•°ï¼Œé‡‡ç”¨éšæœºè·å–æ•°æ®çš„æ–¹å¼ä½œä¸ºå¾…æ£€æµ‹åˆ é™¤æ•°æ®

```properties
maxmemory-samples count
```

3ï¼šå¯¹æ•°æ®è¿›è¡Œåˆ é™¤çš„é€‰æ‹©ç­–ç•¥

```properties
maxmemory-policy policy
```

é‚£æ•°æ®åˆ é™¤çš„ç­–ç•¥policyåˆ°åº•æœ‰å‡ ç§å‘¢ï¼Ÿä¸€å…±æ˜¯**3ç±»8ç§**

**ç¬¬ä¸€ç±»**ï¼šæ£€æµ‹æ˜“å¤±æ•°æ®ï¼ˆå¯èƒ½ä¼šè¿‡æœŸçš„æ•°æ®é›†server.db[i].expires ï¼‰

```properties
volatile-lruï¼šæŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°
volatile-lfuï¼šæŒ‘é€‰æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°
volatile-ttlï¼šæŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°
volatile-randomï¼šä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°
```

![](./img/lru.png)

**ç¬¬äºŒç±»**ï¼šæ£€æµ‹å…¨åº“æ•°æ®ï¼ˆæ‰€æœ‰æ•°æ®é›†server.db[i].dict ï¼‰

```properties
allkeys-lruï¼šæŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°
allkeLyRs-lfuï¼šï¼šæŒ‘é€‰æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°
allkeys-randomï¼šä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°ï¼Œç›¸å½“äºéšæœº
```

**ç¬¬ä¸‰ç±»**ï¼šæ”¾å¼ƒæ•°æ®é©±é€

```properties
no-envictionï¼ˆé©±é€ï¼‰ï¼šç¦æ­¢é©±é€æ•°æ®(redis4.0ä¸­é»˜è®¤ç­–ç•¥)ï¼Œä¼šå¼•å‘OOM(Out Of Memory)
```

æ³¨æ„ï¼šè¿™äº›ç­–ç•¥æ˜¯é…ç½®åˆ°å“ªä¸ªå±æ€§ä¸Šï¼Ÿæ€ä¹ˆé…ç½®ï¼Ÿå¦‚ä¸‹æ‰€ç¤º

```properties
maxmemory-policy volatile-lru
```

**æ•°æ®æ·˜æ±°ç­–ç•¥é…ç½®ä¾æ®**

 ä½¿ç”¨INFOå‘½ä»¤è¾“å‡ºç›‘æ§ä¿¡æ¯ï¼ŒæŸ¥è¯¢ç¼“å­˜ hit å’Œ miss çš„æ¬¡æ•°ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒä¼˜Redisé…ç½®

## 2.ä¸»ä»å¤åˆ¶

### 2.1 ä¸»ä»å¤åˆ¶ç®€ä»‹

#### 2.1.1 é«˜å¯ç”¨

é¦–å…ˆæˆ‘ä»¬è¦ç†è§£äº’è”ç½‘åº”ç”¨å› ä¸ºå…¶ç‹¬æœ‰çš„ç‰¹æ€§æˆ‘ä»¬æ¼”åŒ–å‡ºçš„**ä¸‰é«˜**æ¶æ„

- é«˜å¹¶å‘

  > åº”ç”¨è¦æä¾›æŸä¸€ä¸šåŠ¡è¦èƒ½æ”¯æŒå¾ˆå¤šå®¢æˆ·ç«¯åŒæ—¶è®¿é—®çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬ç§°ä¸ºå¹¶å‘ï¼Œé«˜å¹¶å‘æ„æ€å°±å¾ˆæ˜ç¡®äº†

- é«˜æ€§èƒ½

  >æ€§èƒ½å¸¦ç»™æˆ‘ä»¬æœ€ç›´è§‚çš„æ„Ÿå—å°±æ˜¯ï¼šé€Ÿåº¦å¿«ï¼Œæ—¶é—´çŸ­

- é«˜å¯ç”¨

**å¯ç”¨æ€§**ï¼šä¸€å¹´ä¸­åº”ç”¨æœåŠ¡æ­£å¸¸è¿è¡Œçš„æ—¶é—´å å…¨å¹´æ—¶é—´çš„ç™¾åˆ†æ¯”ï¼Œå¦‚ä¸‹å›¾ï¼šè¡¨ç¤ºäº†åº”ç”¨æœåŠ¡åœ¨å…¨å¹´å®•æœºçš„æ—¶é—´

![](./img/5.png)

æˆ‘ä»¬æŠŠè¿™äº›æ—¶é—´åŠ åœ¨ä¸€èµ·å°±æ˜¯å…¨å¹´åº”ç”¨æœåŠ¡ä¸å¯ç”¨çš„æ—¶é—´ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥å¾—åˆ°åº”ç”¨æœåŠ¡å…¨å¹´å¯ç”¨çš„æ—¶é—´

>4å°æ—¶27åˆ†15ç§’+11åˆ†36ç§’+2åˆ†16ç§’=4å°æ—¶41åˆ†7ç§’=16867ç§’
>
>1å¹´=365*24*60*60=31536000ç§’
>
>å¯ç”¨æ€§=ï¼ˆ31536000-16867ï¼‰/31536000*100%=99.9465151%

ä¸šç•Œå¯ç”¨æ€§ç›®æ ‡**5ä¸ª9ï¼Œå³99.999%**ï¼Œå³æœåŠ¡å™¨å¹´å®•æœºæ—¶é•¿ä½äº315ç§’ï¼Œçº¦5.25åˆ†é’Ÿ



#### 2.1.2 ä¸»ä»å¤åˆ¶æ¦‚å¿µ

çŸ¥é“äº†ä¸‰é«˜çš„æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬æƒ³ï¼šä½ çš„â€œRedisâ€æ˜¯å¦é«˜å¯ç”¨ï¼Ÿé‚£æˆ‘ä»¬è¦æ¥åˆ†æå•æœºredisçš„é£é™©ä¸é—®é¢˜

é—®é¢˜1.æœºå™¨æ•…éšœ

- ç°è±¡ï¼šç¡¬ç›˜æ•…éšœã€ç³»ç»Ÿå´©æºƒ
- æœ¬è´¨ï¼šæ•°æ®ä¸¢å¤±ï¼Œå¾ˆå¯èƒ½å¯¹ä¸šåŠ¡é€ æˆç¾éš¾æ€§æ‰“å‡»
- ç»“è®ºï¼šåŸºæœ¬ä¸Šä¼šæ”¾å¼ƒä½¿ç”¨redis.

é—®é¢˜2.å®¹é‡ç“¶é¢ˆ

- ç°è±¡ï¼šå†…å­˜ä¸è¶³ï¼Œä»16Gå‡çº§åˆ°64Gï¼Œä»64Gå‡çº§åˆ°128Gï¼Œæ— é™å‡çº§å†…å­˜
- æœ¬è´¨ï¼šç©·ï¼Œç¡¬ä»¶æ¡ä»¶è·Ÿä¸ä¸Š
- ç»“è®ºï¼šæ”¾å¼ƒä½¿ç”¨redis

ç»“è®ºï¼š

ä¸ºäº†é¿å…å•ç‚¹RedisæœåŠ¡å™¨æ•…éšœï¼Œå‡†å¤‡å¤šå°æœåŠ¡å™¨ï¼Œäº’ç›¸è¿é€šã€‚å°†æ•°æ®å¤åˆ¶å¤šä¸ªå‰¯æœ¬ä¿å­˜åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œè¿æ¥åœ¨ä¸€èµ·ï¼Œå¹¶ä¿è¯æ•°æ®æ˜¯åŒæ­¥çš„ã€‚å³ä½¿æœ‰å…¶ä¸­ä¸€å°æœåŠ¡å™¨å®•æœºï¼Œå…¶ä»–æœåŠ¡å™¨ä¾ç„¶å¯ä»¥ç»§ç»­æä¾›æœåŠ¡ï¼Œå®ç°Redisçš„é«˜å¯ç”¨ï¼ŒåŒæ—¶å®ç°æ•°æ®å†—ä½™å¤‡ä»½ã€‚

å¤šå°æœåŠ¡å™¨è¿æ¥æ–¹æ¡ˆï¼š

![](./img/6.png)

- æä¾›æ•°æ®æ–¹ï¼š**master**

ä¸»æœåŠ¡å™¨ï¼Œä¸»èŠ‚ç‚¹ï¼Œä¸»åº“ä¸»å®¢æˆ·ç«¯

- æ¥æ”¶æ•°æ®æ–¹ï¼š**slave**

ä»æœåŠ¡å™¨ï¼Œä»èŠ‚ç‚¹ï¼Œä»åº“

ä»å®¢æˆ·ç«¯

- éœ€è¦è§£å†³çš„é—®é¢˜ï¼š

æ•°æ®åŒæ­¥ï¼ˆmasterçš„æ•°æ®å¤åˆ¶åˆ°slaveä¸­ï¼‰



è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ¥è§£é‡Šä¸»ä»å¤åˆ¶çš„æ¦‚å¿µï¼š

**æ¦‚å¿µï¼šä¸»ä»å¤åˆ¶å³å°†masterä¸­çš„æ•°æ®å³æ—¶ã€æœ‰æ•ˆçš„å¤åˆ¶åˆ°slaveä¸­**

**ç‰¹å¾**ï¼šä¸€ä¸ªmasterå¯ä»¥æ‹¥æœ‰å¤šä¸ªslaveï¼Œä¸€ä¸ªslaveåªå¯¹åº”ä¸€ä¸ªmaster

**èŒè´£**ï¼šmasterå’Œslaveå„è‡ªçš„èŒè´£ä¸ä¸€æ ·

master:

```markdown
å†™æ•°æ®

æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå°†å‡ºç°å˜åŒ–çš„æ•°æ®è‡ªåŠ¨åŒæ­¥åˆ°slave

è¯»æ•°æ®ï¼ˆå¯å¿½ç•¥ï¼‰
```

slave:

```markdown
è¯»æ•°æ®

å†™æ•°æ®ï¼ˆç¦æ­¢ï¼‰
```

#### 2.1.3 ä¸»ä»å¤åˆ¶çš„ä½œç”¨

- è¯»å†™åˆ†ç¦»ï¼šmasterå†™ã€slaveè¯»ï¼Œæé«˜æœåŠ¡å™¨çš„è¯»å†™è´Ÿè½½èƒ½åŠ›
- è´Ÿè½½å‡è¡¡ï¼šåŸºäºä¸»ä»ç»“æ„ï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œç”±slaveåˆ†æ‹…masterè´Ÿè½½ï¼Œå¹¶æ ¹æ®éœ€æ±‚çš„å˜åŒ–ï¼Œæ”¹å˜slaveçš„æ•° é‡ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…æ•°æ®è¯»å–è´Ÿè½½ï¼Œå¤§å¤§æé«˜RedisæœåŠ¡å™¨å¹¶å‘é‡ä¸æ•°æ®ååé‡
- æ•…éšœæ¢å¤ï¼šå½“masterå‡ºç°é—®é¢˜æ—¶ï¼Œç”±slaveæä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤
- æ•°æ®å†—ä½™ï¼šå®ç°æ•°æ®çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼
- é«˜å¯ç”¨åŸºçŸ³ï¼šåŸºäºä¸»ä»å¤åˆ¶ï¼Œæ„å»ºå“¨å…µæ¨¡å¼ä¸é›†ç¾¤ï¼Œå®ç°Redisçš„é«˜å¯ç”¨æ–¹æ¡ˆ

### 2.2 ä¸»ä»å¤åˆ¶å·¥ä½œæµç¨‹

ä¸»ä»å¤åˆ¶è¿‡ç¨‹å¤§ä½“å¯ä»¥åˆ†ä¸º3ä¸ªé˜¶æ®µ

- å»ºç«‹è¿æ¥é˜¶æ®µï¼ˆå³å‡†å¤‡é˜¶æ®µï¼‰
- æ•°æ®åŒæ­¥é˜¶æ®µ
- å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼ˆåå¤åŒæ­¥ï¼‰

![](./img/7.png)

è€Œå‘½ä»¤çš„ä¼ æ’­å…¶å®æœ‰4ç§ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

![](./img/8.png)



#### 2.2.1 ä¸»ä»å¤åˆ¶çš„å·¥ä½œæµç¨‹ï¼ˆä¸‰ä¸ªé˜¶æ®µï¼‰

##### 2.2.1.1 é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥

å»ºç«‹slaveåˆ°masterçš„è¿æ¥ï¼Œä½¿masterèƒ½å¤Ÿè¯†åˆ«slaveï¼Œå¹¶ä¿å­˜slaveç«¯å£å·

æµç¨‹å¦‚ä¸‹ï¼š

1. æ­¥éª¤1ï¼šè®¾ç½®masterçš„åœ°å€å’Œç«¯å£ï¼Œä¿å­˜masterä¿¡æ¯
2. æ­¥éª¤2ï¼šå»ºç«‹socketè¿æ¥
3. æ­¥éª¤3ï¼šå‘é€pingå‘½ä»¤ï¼ˆå®šæ—¶å™¨ä»»åŠ¡ï¼‰
4. æ­¥éª¤4ï¼šèº«ä»½éªŒè¯
5. æ­¥éª¤5ï¼šå‘é€slaveç«¯å£ä¿¡æ¯

è‡³æ­¤ï¼Œä¸»ä»è¿æ¥æˆåŠŸï¼

å½“å‰çŠ¶æ€ï¼š

slaveï¼šä¿å­˜masterçš„åœ°å€ä¸ç«¯å£

masterï¼šä¿å­˜slaveçš„ç«¯å£

æ€»ä½“ï¼šä¹‹é—´åˆ›å»ºäº†è¿æ¥çš„socket

![](./img/9.png)



**masterå’Œslaveäº’è”**

æ¥ä¸‹æ¥å°±è¦é€šè¿‡æŸç§æ–¹å¼å°†masterå’Œslaveè¿æ¥åˆ°ä¸€èµ·

æ–¹å¼ä¸€ï¼šå®¢æˆ·ç«¯å‘é€å‘½ä»¤

```properties
slaveof masterip masterport
```

æ–¹å¼äºŒï¼šå¯åŠ¨æœåŠ¡å™¨å‚æ•°

```properties
redis-server --slaveof masterip masterport
```

æ–¹å¼ä¸‰ï¼šæœåŠ¡å™¨é…ç½®ï¼ˆ**ä¸»æµæ–¹å¼**ï¼‰

```properties
slaveof masterip masterport
```

slaveç³»ç»Ÿä¿¡æ¯

```properties
master_link_down_since_seconds
masterhost & masterport
```

masterç³»ç»Ÿä¿¡æ¯

```properties
uslave_listening_port(å¤šä¸ª)
```

**ä¸»ä»æ–­å¼€è¿æ¥**

æ–­å¼€slaveä¸masterçš„è¿æ¥ï¼Œslaveæ–­å¼€è¿æ¥åï¼Œä¸ä¼šåˆ é™¤å·²æœ‰æ•°æ®ï¼Œåªæ˜¯ä¸å†æ¥å—masterå‘é€çš„æ•°æ®

```properties
slaveof no one
```

**æˆæƒè®¿é—®**

masterå®¢æˆ·ç«¯å‘é€å‘½ä»¤è®¾ç½®å¯†ç 

```properties
requirepass password
```

masteré…ç½®æ–‡ä»¶è®¾ç½®å¯†ç 

```properties
config set requirepass password
config get requirepass
```

slaveå®¢æˆ·ç«¯å‘é€å‘½ä»¤è®¾ç½®å¯†ç 

```properties
auth password
```

slaveé…ç½®æ–‡ä»¶è®¾ç½®å¯†ç 

```properties
masterauth password
```

slaveå¯åŠ¨æœåŠ¡å™¨è®¾ç½®å¯†ç 

```properties
redis-server â€“a password
```



##### 2.2.1.2 é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥

- åœ¨slaveåˆæ¬¡è¿æ¥masteråï¼Œå¤åˆ¶masterä¸­çš„æ‰€æœ‰æ•°æ®åˆ°slave
- å°†slaveçš„æ•°æ®åº“çŠ¶æ€æ›´æ–°æˆmasterå½“å‰çš„æ•°æ®åº“çŠ¶æ€

åŒæ­¥è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. æ­¥éª¤1ï¼šè¯·æ±‚åŒæ­¥æ•°æ®
2. æ­¥éª¤2ï¼šåˆ›å»ºRDBåŒæ­¥æ•°æ®
3. æ­¥éª¤3ï¼šæ¢å¤RDBåŒæ­¥æ•°æ®
4. æ­¥éª¤4ï¼šè¯·æ±‚éƒ¨åˆ†åŒæ­¥æ•°æ®
5. æ­¥éª¤5ï¼šæ¢å¤éƒ¨åˆ†åŒæ­¥æ•°æ®

è‡³æ­¤ï¼Œæ•°æ®åŒæ­¥å·¥ä½œå®Œæˆï¼

å½“å‰çŠ¶æ€ï¼š

slaveï¼šå…·æœ‰masterç«¯å…¨éƒ¨æ•°æ®ï¼ŒåŒ…å«RDBè¿‡ç¨‹æ¥æ”¶çš„æ•°æ®

masterï¼šä¿å­˜slaveå½“å‰æ•°æ®åŒæ­¥çš„ä½ç½®

æ€»ä½“ï¼šä¹‹é—´å®Œæˆäº†æ•°æ®å…‹éš†

![](./img/10.png)

**æ•°æ®åŒæ­¥é˜¶æ®µmasterè¯´æ˜**

1ï¼šå¦‚æœmasteræ•°æ®é‡å·¨å¤§ï¼Œæ•°æ®åŒæ­¥é˜¶æ®µåº”é¿å¼€æµé‡é«˜å³°æœŸï¼Œé¿å…é€ æˆmasteré˜»å¡ï¼Œå½±å“ä¸šåŠ¡æ­£å¸¸æ‰§è¡Œ

2ï¼šå¤åˆ¶ç¼“å†²åŒºå¤§å°è®¾å®šä¸åˆç†ï¼Œä¼šå¯¼è‡´æ•°æ®æº¢å‡ºã€‚å¦‚è¿›è¡Œå…¨é‡å¤åˆ¶å‘¨æœŸå¤ªé•¿ï¼Œè¿›è¡Œéƒ¨åˆ†å¤åˆ¶æ—¶å‘ç°æ•°æ®å·²ç»å­˜åœ¨ä¸¢å¤±çš„æƒ…å†µï¼Œå¿…é¡»è¿›è¡Œç¬¬äºŒæ¬¡å…¨é‡å¤åˆ¶ï¼Œè‡´ä½¿slaveé™·å…¥æ­»å¾ªç¯çŠ¶æ€ã€‚

```properties
repl-backlog-size ?mb
```

3. masterå•æœºå†…å­˜å ç”¨ä¸»æœºå†…å­˜çš„æ¯”ä¾‹ä¸åº”è¿‡å¤§ï¼Œå»ºè®®ä½¿ç”¨50%-70%çš„å†…å­˜ï¼Œç•™ä¸‹30%-50%çš„å†…å­˜ç”¨äºæ‰§ è¡Œbgsaveå‘½ä»¤å’Œåˆ›å»ºå¤åˆ¶ç¼“å†²åŒº

![](./img/11.png)

**æ•°æ®åŒæ­¥é˜¶æ®µslaveè¯´æ˜**

1. ä¸ºé¿å…slaveè¿›è¡Œå…¨é‡å¤åˆ¶ã€éƒ¨åˆ†å¤åˆ¶æ—¶æœåŠ¡å™¨å“åº”é˜»å¡æˆ–æ•°æ®ä¸åŒæ­¥ï¼Œå»ºè®®å…³é—­æ­¤æœŸé—´çš„å¯¹å¤–æœåŠ¡
```properties
   slave-serve-stale-data yes|no
```

2. æ•°æ®åŒæ­¥é˜¶æ®µï¼Œmasterå‘é€ç»™slaveä¿¡æ¯å¯ä»¥ç†è§£masteræ˜¯slaveçš„ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¸»åŠ¨å‘slaveå‘é€å‘½ä»¤

3. å¤šä¸ªslaveåŒæ—¶å¯¹masterè¯·æ±‚æ•°æ®åŒæ­¥ï¼Œmasterå‘é€çš„RDBæ–‡ä»¶å¢å¤šï¼Œä¼šå¯¹å¸¦å®½é€ æˆå·¨å¤§å†²å‡»ï¼Œå¦‚æœmasterå¸¦å®½ä¸è¶³ï¼Œå› æ­¤æ•°æ®åŒæ­¥éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œé€‚é‡é”™å³°

4. slaveè¿‡å¤šæ—¶ï¼Œå»ºè®®è°ƒæ•´æ‹“æ‰‘ç»“æ„ï¼Œç”±ä¸€ä¸»å¤šä»ç»“æ„å˜ä¸ºæ ‘çŠ¶ç»“æ„ï¼Œä¸­é—´çš„èŠ‚ç‚¹æ—¢æ˜¯masterï¼Œä¹Ÿæ˜¯ slaveã€‚æ³¨æ„ä½¿ç”¨æ ‘çŠ¶ç»“æ„æ—¶ï¼Œç”±äºå±‚çº§æ·±åº¦ï¼Œå¯¼è‡´æ·±åº¦è¶Šé«˜çš„slaveä¸æœ€é¡¶å±‚masteré—´æ•°æ®åŒæ­¥å»¶è¿Ÿ è¾ƒå¤§ï¼Œæ•°æ®ä¸€è‡´æ€§å˜å·®ï¼Œåº”è°¨æ…é€‰æ‹©

##### 2.2.1.3 é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­

- å½“masteræ•°æ®åº“çŠ¶æ€è¢«ä¿®æ”¹åï¼Œå¯¼è‡´ä¸»ä»æœåŠ¡å™¨æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ­¤æ—¶éœ€è¦è®©ä¸»ä»æ•°æ®åŒæ­¥åˆ°ä¸€è‡´çš„çŠ¶æ€ï¼ŒåŒæ­¥çš„åŠ¨ä½œç§°ä¸ºå‘½ä»¤ä¼ æ’­
- masterå°†æ¥æ”¶åˆ°çš„æ•°æ®å˜æ›´å‘½ä»¤å‘é€ç»™slaveï¼Œslaveæ¥æ”¶å‘½ä»¤åæ‰§è¡Œå‘½ä»¤

**å‘½ä»¤ä¼ æ’­é˜¶æ®µçš„éƒ¨åˆ†å¤åˆ¶**

å‘½ä»¤ä¼ æ’­é˜¶æ®µå‡ºç°äº†æ–­ç½‘ç°è±¡ï¼š

ç½‘ç»œé—ªæ–­é—ªè¿ï¼šå¿½ç•¥

çŸ­æ—¶é—´ç½‘ç»œä¸­æ–­ï¼šéƒ¨åˆ†å¤åˆ¶

é•¿æ—¶é—´ç½‘ç»œä¸­æ–­ï¼šå…¨é‡å¤åˆ¶



è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹éƒ¨åˆ†å¤åˆ¶ï¼Œéƒ¨åˆ†å¤åˆ¶çš„ä¸‰ä¸ªæ ¸å¿ƒè¦ç´ 

1. æœåŠ¡å™¨çš„è¿è¡Œ idï¼ˆrun idï¼‰
2. ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒº
3. ä¸»ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡

- æœåŠ¡å™¨è¿è¡ŒIDï¼ˆrunidï¼‰

```markdown
æ¦‚å¿µï¼šæœåŠ¡å™¨è¿è¡ŒIDæ˜¯æ¯ä¸€å°æœåŠ¡å™¨æ¯æ¬¡è¿è¡Œçš„èº«ä»½è¯†åˆ«ç ï¼Œä¸€å°æœåŠ¡å™¨å¤šæ¬¡è¿è¡Œå¯ä»¥ç”Ÿæˆå¤šä¸ªè¿è¡Œid

ç»„æˆï¼šè¿è¡Œidç”±40ä½å­—ç¬¦ç»„æˆï¼Œæ˜¯ä¸€ä¸ªéšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦
ä¾‹å¦‚ï¼šfdc9ff13b9bbaab28db42b3d50f852bb5e3fcdce

ä½œç”¨ï¼šè¿è¡Œidè¢«ç”¨äºåœ¨æœåŠ¡å™¨é—´è¿›è¡Œä¼ è¾“ï¼Œè¯†åˆ«èº«ä»½
å¦‚æœæƒ³ä¸¤æ¬¡æ“ä½œå‡å¯¹åŒä¸€å°æœåŠ¡å™¨è¿›è¡Œï¼Œå¿…é¡»æ¯æ¬¡æ“ä½œæºå¸¦å¯¹åº”çš„è¿è¡Œidï¼Œç”¨äºå¯¹æ–¹è¯†åˆ«

å®ç°æ–¹å¼ï¼šè¿è¡Œidåœ¨æ¯å°æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œmasteråœ¨é¦–æ¬¡è¿æ¥slaveæ—¶ï¼Œä¼šå°†è‡ªå·±çš„è¿è¡ŒIDå‘é€ç»™slaveï¼Œ
slaveä¿å­˜æ­¤IDï¼Œé€šè¿‡info Serverå‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹èŠ‚ç‚¹çš„runid
```

- å¤åˆ¶ç¼“å†²åŒº

```markdown
æ¦‚å¿µï¼šå¤åˆ¶ç¼“å†²åŒºï¼Œåˆåå¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨æœåŠ¡å™¨æ‰§è¡Œè¿‡çš„å‘½ä»¤ï¼Œæ¯æ¬¡ä¼ æ’­å‘½ä»¤ï¼Œmasteréƒ½ä¼šå°†ä¼ æ’­çš„å‘½ä»¤è®°å½•ä¸‹æ¥ï¼Œå¹¶å­˜å‚¨åœ¨å¤åˆ¶ç¼“å†²åŒº
	å¤åˆ¶ç¼“å†²åŒºé»˜è®¤æ•°æ®å­˜å‚¨ç©ºé—´å¤§å°æ˜¯1M
	å½“å…¥é˜Ÿå…ƒç´ çš„æ•°é‡å¤§äºé˜Ÿåˆ—é•¿åº¦æ—¶ï¼Œæœ€å…ˆå…¥é˜Ÿçš„å…ƒç´ ä¼šè¢«å¼¹å‡ºï¼Œè€Œæ–°å…ƒç´ ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—
ä½œç”¨ï¼šç”¨äºä¿å­˜masteræ”¶åˆ°çš„æ‰€æœ‰æŒ‡ä»¤ï¼ˆä»…å½±å“æ•°æ®å˜æ›´çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚setï¼Œselectï¼‰

æ•°æ®æ¥æºï¼šå½“masteræ¥æ”¶åˆ°ä¸»å®¢æˆ·ç«¯çš„æŒ‡ä»¤æ—¶ï¼Œé™¤äº†å°†æŒ‡ä»¤æ‰§è¡Œï¼Œä¼šå°†è¯¥æŒ‡ä»¤å­˜å‚¨åˆ°ç¼“å†²åŒºä¸­
```

![](./img/12.png)

å¤åˆ¶ç¼“å†²åŒºå†…éƒ¨å·¥ä½œåŸç†ï¼š

ç»„æˆ

- åç§»é‡

  >æ¦‚å¿µï¼šä¸€ä¸ªæ•°å­—ï¼Œæè¿°å¤åˆ¶ç¼“å†²åŒºä¸­çš„æŒ‡ä»¤å­—èŠ‚ä½ç½®
  >
  >åˆ†ç±»ï¼š
  >
  >- masterå¤åˆ¶åç§»é‡ï¼šè®°å½•å‘é€ç»™æ‰€æœ‰slaveçš„æŒ‡ä»¤å­—èŠ‚å¯¹åº”çš„ä½ç½®ï¼ˆå¤šä¸ªï¼‰
  >- slaveå¤åˆ¶åç§»é‡ï¼šè®°å½•slaveæ¥æ”¶masterå‘é€è¿‡æ¥çš„æŒ‡ä»¤å­—èŠ‚å¯¹åº”çš„ä½ç½®ï¼ˆä¸€ä¸ªï¼‰
  >
  >ä½œç”¨ï¼šåŒæ­¥ä¿¡æ¯ï¼Œæ¯”å¯¹masterä¸slaveçš„å·®å¼‚ï¼Œå½“slaveæ–­çº¿åï¼Œæ¢å¤æ•°æ®ä½¿ç”¨
  >
  >æ•°æ®æ¥æºï¼š
  >
  >- masterç«¯ï¼šå‘é€ä¸€æ¬¡è®°å½•ä¸€æ¬¡
  >- slaveç«¯ï¼šæ¥æ”¶ä¸€æ¬¡è®°å½•ä¸€æ¬¡

- å­—èŠ‚å€¼

å·¥ä½œåŸç†

- é€šè¿‡offsetåŒºåˆ†ä¸åŒçš„slaveå½“å‰æ•°æ®ä¼ æ’­çš„å·®å¼‚
- masterè®°å½•å·²å‘é€çš„ä¿¡æ¯å¯¹åº”çš„offset
- slaveè®°å½•å·²æ¥æ”¶çš„ä¿¡æ¯å¯¹åº”çš„offset

![](./img/13.png)



#### 2.2.2 æµç¨‹æ›´æ–°(å…¨é‡å¤åˆ¶/éƒ¨åˆ†å¤åˆ¶)

æˆ‘ä»¬å†æ¬¡çš„æ€»ç»“ä¸€ä¸‹ä¸»ä»å¤åˆ¶çš„ä¸‰ä¸ªé˜¶æ®µçš„å·¥ä½œæµç¨‹ï¼š

![](./img/14.png)

#### 2.2.3 å¿ƒè·³æœºåˆ¶

ä»€ä¹ˆæ˜¯å¿ƒè·³æœºåˆ¶ï¼Ÿ

è¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µå€™ï¼Œmasterä¸slaveé—´éœ€è¦è¿›è¡Œä¿¡æ¯äº¤æ¢ï¼Œä½¿ç”¨å¿ƒè·³æœºåˆ¶è¿›è¡Œç»´æŠ¤ï¼Œå®ç°åŒæ–¹è¿æ¥ä¿æŒåœ¨çº¿

masterå¿ƒè·³ï¼š

- å†…éƒ¨æŒ‡ä»¤ï¼šPING
- å‘¨æœŸï¼šç”±repl-ping-slave-periodå†³å®šï¼Œé»˜è®¤10ç§’
- ä½œç”¨ï¼šåˆ¤æ–­slaveæ˜¯å¦åœ¨çº¿
- æŸ¥è¯¢ï¼šINFO replication  è·å–slaveæœ€åä¸€æ¬¡è¿æ¥æ—¶é—´é—´éš”ï¼Œlagé¡¹ç»´æŒåœ¨0æˆ–1è§†ä¸ºæ­£å¸¸

slaveå¿ƒè·³ä»»åŠ¡

- å†…éƒ¨æŒ‡ä»¤ï¼šREPLCONF ACK {offset}
- å‘¨æœŸï¼š1ç§’
- ä½œç”¨1ï¼šæ±‡æŠ¥slaveè‡ªå·±çš„å¤åˆ¶åç§»é‡ï¼Œè·å–æœ€æ–°çš„æ•°æ®å˜æ›´æŒ‡ä»¤
- ä½œç”¨2ï¼šåˆ¤æ–­masteræ˜¯å¦åœ¨çº¿

å¿ƒè·³é˜¶æ®µæ³¨æ„äº‹é¡¹ï¼š

- å½“slaveå¤šæ•°æ‰çº¿ï¼Œæˆ–å»¶è¿Ÿè¿‡é«˜æ—¶ï¼Œmasterä¸ºä¿éšœæ•°æ®ç¨³å®šæ€§ï¼Œå°†æ‹’ç»æ‰€æœ‰ä¿¡æ¯åŒæ­¥

```properties
min-slaves-to-write 2
min-slaves-max-lag 8
```

slaveæ•°é‡å°‘äº2ä¸ªï¼Œæˆ–è€…æ‰€æœ‰slaveçš„å»¶è¿Ÿéƒ½å¤§äºç­‰äº8ç§’æ—¶ï¼Œå¼ºåˆ¶å…³é—­masterå†™åŠŸèƒ½ï¼Œåœæ­¢æ•°æ®åŒæ­¥

- slaveæ•°é‡ç”±slaveå‘é€REPLCONF ACKå‘½ä»¤åšç¡®è®¤


- slaveå»¶è¿Ÿç”±slaveå‘é€REPLCONF ACKå‘½ä»¤åšç¡®è®¤



è‡³æ­¤ï¼šæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºå®Œæ•´çš„ä¸»ä»å¤åˆ¶æµç¨‹ï¼š

![](./img/15.png)

### 2.3 ä¸»ä»å¤åˆ¶å¸¸è§é—®é¢˜

#### 2.3.1 é¢‘ç¹çš„å…¨é‡å¤åˆ¶

- ä¼´éšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œmasterçš„æ•°æ®é‡ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸€æ—¦masteré‡å¯ï¼Œrunidå°†å‘ç”Ÿå˜åŒ–ï¼Œä¼šå¯¼è‡´å…¨éƒ¨slaveçš„å…¨é‡å¤åˆ¶æ“ä½œ


å†…éƒ¨ä¼˜åŒ–è°ƒæ•´æ–¹æ¡ˆï¼š

1ï¼šmasterå†…éƒ¨åˆ›å»ºmaster_replidå˜é‡ï¼Œä½¿ç”¨runidç›¸åŒçš„ç­–ç•¥ç”Ÿæˆï¼Œé•¿åº¦41ä½ï¼Œå¹¶å‘é€ç»™æ‰€æœ‰slave

2ï¼šåœ¨masterå…³é—­æ—¶æ‰§è¡Œå‘½ä»¤shutdown saveï¼Œè¿›è¡ŒRDBæŒä¹…åŒ–,å°†runidä¸offsetä¿å­˜åˆ°RDBæ–‡ä»¶ä¸­

```markdown
repl-id  repl-offset

é€šè¿‡redis-check-rdbå‘½ä»¤å¯ä»¥æŸ¥çœ‹è¯¥ä¿¡æ¯
```

3ï¼šmasteré‡å¯ååŠ è½½RDBæ–‡ä»¶ï¼Œæ¢å¤æ•°æ®ï¼Œé‡å¯åï¼Œå°†RDBæ–‡ä»¶ä¸­ä¿å­˜çš„repl-idä¸repl-offsetåŠ è½½åˆ°å†…å­˜ä¸­

```markdown
master_repl_id=repl  master_repl_offset =repl-offset

é€šè¿‡infoå‘½ä»¤å¯ä»¥æŸ¥çœ‹è¯¥ä¿¡æ¯
```

ä½œç”¨ï¼šæœ¬æœºä¿å­˜ä¸Šæ¬¡runidï¼Œé‡å¯åæ¢å¤è¯¥å€¼ï¼Œä½¿æ‰€æœ‰slaveè®¤ä¸ºè¿˜æ˜¯ä¹‹å‰çš„master



- ç¬¬äºŒç§å‡ºç°é¢‘ç¹å…¨é‡å¤åˆ¶çš„é—®é¢˜ç°è±¡ï¼šç½‘ç»œç¯å¢ƒä¸ä½³ï¼Œå‡ºç°ç½‘ç»œä¸­æ–­ï¼Œslaveä¸æä¾›æœåŠ¡


é—®é¢˜åŸå› ï¼šå¤åˆ¶ç¼“å†²åŒºè¿‡å°ï¼Œæ–­ç½‘åslaveçš„offsetè¶Šç•Œï¼Œè§¦å‘å…¨é‡å¤åˆ¶

æœ€ç»ˆç»“æœï¼šslaveåå¤è¿›è¡Œå…¨é‡å¤åˆ¶

è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹å¤åˆ¶ç¼“å†²åŒºå¤§å°

```properties
repl-backlog-size ?mb
```

å»ºè®®è®¾ç½®å¦‚ä¸‹ï¼š

1.æµ‹ç®—ä»masteråˆ°slaveçš„é‡è¿å¹³å‡æ—¶é•¿second

2.è·å–masterå¹³å‡æ¯ç§’äº§ç”Ÿå†™å‘½ä»¤æ•°æ®æ€»é‡write_size_per_second

3.æœ€ä¼˜å¤åˆ¶ç¼“å†²åŒºç©ºé—´ = 2 * second * write_size_per_second



#### 2.3.2 é¢‘ç¹çš„ç½‘ç»œä¸­æ–­

- é—®é¢˜ç°è±¡ï¼šmasterçš„CPUå ç”¨è¿‡é«˜ æˆ– slaveé¢‘ç¹æ–­å¼€è¿æ¥


é—®é¢˜åŸå› 

```markdown
slaveæ¯1ç§’å‘é€REPLCONFACKå‘½ä»¤åˆ°master

å½“slaveæ¥åˆ°äº†æ…¢æŸ¥è¯¢æ—¶ï¼ˆkeys * ï¼Œhgetallç­‰ï¼‰ï¼Œä¼šå¤§é‡å ç”¨CPUæ€§èƒ½

masteræ¯1ç§’è°ƒç”¨å¤åˆ¶å®šæ—¶å‡½æ•°replicationCron()ï¼Œæ¯”å¯¹slaveå‘ç°é•¿æ—¶é—´æ²¡æœ‰è¿›è¡Œå“åº”
```

æœ€ç»ˆç»“æœï¼šmasterå„ç§èµ„æºï¼ˆè¾“å‡ºç¼“å†²åŒºã€å¸¦å®½ã€è¿æ¥ç­‰ï¼‰è¢«ä¸¥é‡å ç”¨

è§£å†³æ–¹æ¡ˆï¼šé€šè¿‡è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œç¡®è®¤æ˜¯å¦é‡Šæ”¾slave

```properties
repl-timeout seconds
```

è¯¥å‚æ•°å®šä¹‰äº†è¶…æ—¶æ—¶é—´çš„é˜ˆå€¼ï¼ˆé»˜è®¤60ç§’ï¼‰ï¼Œè¶…è¿‡è¯¥å€¼ï¼Œé‡Šæ”¾slave



- é—®é¢˜ç°è±¡ï¼šslaveä¸masterè¿æ¥æ–­å¼€


é—®é¢˜åŸå› 

```markdown
masterå‘é€pingæŒ‡ä»¤é¢‘åº¦è¾ƒä½

masterè®¾å®šè¶…æ—¶æ—¶é—´è¾ƒçŸ­

pingæŒ‡ä»¤åœ¨ç½‘ç»œä¸­å­˜åœ¨ä¸¢åŒ…
```

è§£å†³æ–¹æ¡ˆï¼šæé«˜pingæŒ‡ä»¤å‘é€çš„é¢‘åº¦

```properties
repl-ping-slave-period seconds
```

è¶…æ—¶æ—¶é—´repl-timeçš„æ—¶é—´è‡³å°‘æ˜¯pingæŒ‡ä»¤é¢‘åº¦çš„5åˆ°10å€ï¼Œå¦åˆ™slaveå¾ˆå®¹æ˜“åˆ¤å®šè¶…æ—¶

#### 2.3.3 æ•°æ®ä¸ä¸€è‡´

é—®é¢˜ç°è±¡ï¼šå¤šä¸ªslaveè·å–ç›¸åŒæ•°æ®ä¸åŒæ­¥

é—®é¢˜åŸå› ï¼šç½‘ç»œä¿¡æ¯ä¸åŒæ­¥ï¼Œæ•°æ®å‘é€æœ‰å»¶è¿Ÿ

è§£å†³æ–¹æ¡ˆ

```markdown
ä¼˜åŒ–ä¸»ä»é—´çš„ç½‘ç»œç¯å¢ƒï¼Œé€šå¸¸æ”¾ç½®åœ¨åŒä¸€ä¸ªæœºæˆ¿éƒ¨ç½²ï¼Œå¦‚ä½¿ç”¨é˜¿é‡Œäº‘ç­‰äº‘æœåŠ¡å™¨æ—¶è¦æ³¨æ„æ­¤ç°è±¡

ç›‘æ§ä¸»ä»èŠ‚ç‚¹å»¶è¿Ÿï¼ˆé€šè¿‡offsetï¼‰åˆ¤æ–­ï¼Œå¦‚æœslaveå»¶è¿Ÿè¿‡å¤§ï¼Œæš‚æ—¶å±è”½ç¨‹åºå¯¹è¯¥slaveçš„æ•°æ®è®¿é—®
```

```properties
slave-serve-stale-data	yes|no
```

å¼€å¯åä»…å“åº”infoã€slaveofç­‰å°‘æ•°å‘½ä»¤ï¼ˆæ…ç”¨ï¼Œé™¤éå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼‰

## 3.å“¨å…µæ¨¡å¼

### 3.1 å“¨å…µç®€ä»‹

#### 3.1.1 å“¨å…µæ¦‚å¿µ

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼šå¦‚æœredisçš„masterå®•æœºäº†ï¼Œæ­¤æ—¶åº”è¯¥æ€ä¹ˆåŠï¼Ÿ

![](./img/16.png)

é‚£æ­¤æ—¶æˆ‘ä»¬å¯èƒ½éœ€è¦ä»ä¸€å †çš„slaveä¸­é‡æ–°é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„masterï¼Œé‚£è¿™ä¸ªæ“ä½œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿè¿™é‡Œé¢ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‡ºç°å‘¢ï¼Ÿ

![](./img/17.png)

è¦å®ç°è¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±éœ€è¦redisçš„å“¨å…µï¼Œé‚£å“¨å…µæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

**å“¨å…µ**

å“¨å…µ(sentinel) æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç”¨äºå¯¹ä¸»ä»ç»“æ„ä¸­çš„æ¯å°æœåŠ¡å™¨è¿›è¡Œ**ç›‘æ§**ï¼Œå½“å‡ºç°æ•…éšœæ—¶é€šè¿‡**æŠ•ç¥¨**æœºåˆ¶**é€‰æ‹©**æ–°çš„masterå¹¶å°†æ‰€æœ‰slaveè¿æ¥åˆ°æ–°çš„masterã€‚

![](./img/18.png)

#### 3.1.2 å“¨å…µä½œç”¨

å“¨å…µçš„ä½œç”¨ï¼š

- ç›‘æ§ï¼šç›‘æ§masterå’Œslave

  ä¸æ–­çš„æ£€æŸ¥masterå’Œslaveæ˜¯å¦æ­£å¸¸è¿è¡Œ

  masterå­˜æ´»æ£€æµ‹ã€masterä¸slaveè¿è¡Œæƒ…å†µæ£€æµ‹


- é€šçŸ¥ï¼ˆæé†’ï¼‰ï¼šå½“è¢«ç›‘æ§çš„æœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶ï¼Œå‘å…¶ä»–ï¼ˆå“¨å…µé—´ï¼Œå®¢æˆ·ç«¯ï¼‰å‘é€é€šçŸ¥


- è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šæ–­å¼€masterä¸slaveè¿æ¥ï¼Œé€‰å–ä¸€ä¸ªslaveä½œä¸ºmasterï¼Œå°†å…¶ä»–slaveè¿æ¥æ–°çš„masterï¼Œå¹¶å‘ŠçŸ¥å®¢æˆ·ç«¯æ–°çš„æœåŠ¡å™¨åœ°å€

æ³¨æ„ï¼šå“¨å…µä¹Ÿæ˜¯ä¸€å°redisæœåŠ¡å™¨ï¼Œåªæ˜¯ä¸æä¾›æ•°æ®ç›¸å…³æœåŠ¡ï¼Œé€šå¸¸å“¨å…µçš„æ•°é‡é…ç½®ä¸ºå•æ•°

### 3.2 å¯ç”¨å“¨å…µ

é…ç½®å“¨å…µ

- é…ç½®ä¸€æ‹–äºŒçš„ä¸»ä»ç»“æ„ï¼ˆåˆ©ç”¨ä¹‹å‰çš„æ–¹å¼å¯åŠ¨å³å¯ï¼‰

- é…ç½®ä¸‰ä¸ªå“¨å…µï¼ˆé…ç½®ç›¸åŒï¼Œç«¯å£ä¸åŒï¼‰ï¼Œå‚çœ‹sentinel.conf

1ï¼šè®¾ç½®å“¨å…µç›‘å¬çš„ä¸»æœåŠ¡å™¨ä¿¡æ¯ï¼Œ sentinel_numberè¡¨ç¤ºå‚ä¸æŠ•ç¥¨çš„å“¨å…µæ•°é‡

```properties
sentinel monitor master_name  master_host	master_port	 sentinel_number
```
2ï¼šè®¾ç½®åˆ¤å®šæœåŠ¡å™¨å®•æœºæ—¶é•¿ï¼Œè¯¥è®¾ç½®æ§åˆ¶æ˜¯å¦è¿›è¡Œä¸»ä»åˆ‡æ¢

```properties
sentinel down-after-milliseconds master_name	million_seconds
```

3ï¼šè®¾ç½®æ•…éšœåˆ‡æ¢çš„æœ€å¤§è¶…æ—¶æ—¶

```properties
sentinel failover-timeout master_name	million_seconds
```

4ï¼šè®¾ç½®ä¸»ä»åˆ‡æ¢åï¼ŒåŒæ—¶è¿›è¡Œæ•°æ®åŒæ­¥çš„slaveæ•°é‡ï¼Œæ•°å€¼è¶Šå¤§ï¼Œè¦æ±‚ç½‘ç»œèµ„æºè¶Šé«˜ï¼Œæ•°å€¼è¶Šå°ï¼ŒåŒæ­¥æ—¶é—´è¶Šé•¿

```properties
sentinel parallel-syncs master_name sync_slave_number
```


- å¯åŠ¨å“¨å…µ

```properties
redis-sentinel filename
```

### 3.3 å“¨å…µå·¥ä½œåŸç†

å“¨å…µåœ¨è¿›è¡Œä¸»ä»åˆ‡æ¢è¿‡ç¨‹ä¸­ç»å†ä¸‰ä¸ªé˜¶æ®µ

- ç›‘æ§
- é€šçŸ¥
- æ•…éšœè½¬ç§»

#### 3.3.1 ç›‘æ§

ç”¨äºåŒæ­¥å„ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯

![](./img/19.png)

- è·å–å„ä¸ªsentinelçš„çŠ¶æ€ï¼ˆæ˜¯å¦åœ¨çº¿ï¼‰


- è·å–masterçš„çŠ¶æ€

```markdown
masterå±æ€§
	prunid
	proleï¼šmaster
å„ä¸ªslaveçš„è¯¦ç»†ä¿¡æ¯	
```

- è·å–æ‰€æœ‰slaveçš„çŠ¶æ€ï¼ˆæ ¹æ®masterä¸­çš„slaveä¿¡æ¯ï¼‰

```markdown
slaveå±æ€§
	prunid
	proleï¼šslave
	pmaster_hostã€master_port
	poffset
```

å…¶å†…éƒ¨çš„å·¥ä½œåŸç†å…·ä½“å¦‚ä¸‹ï¼š

![](./img/20.png)



#### 3.3.2 é€šçŸ¥

sentinelåœ¨é€šçŸ¥é˜¶æ®µè¦ä¸æ–­çš„å»è·å–master/slaveçš„ä¿¡æ¯ï¼Œç„¶ååœ¨å„ä¸ªsentinelä¹‹é—´è¿›è¡Œå…±äº«ï¼Œå…·ä½“çš„æµç¨‹å¦‚ä¸‹ï¼š

![](./img/21.png)

#### 3.3.3 æ•…éšœè½¬ç§»

å½“masterå®•æœºåsentinelæ˜¯å¦‚ä½•çŸ¥æ™“å¹¶åˆ¤æ–­å‡ºmasteræ˜¯çœŸçš„å®•æœºäº†å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹å…·ä½“çš„æ“ä½œæµç¨‹

![](./img/22.png)

å½“sentinelè®¤å®šmasterä¸‹çº¿ä¹‹åï¼Œæ­¤æ—¶éœ€è¦å†³å®šæ›´æ¢masterï¼Œé‚£è¿™ä»¶äº‹ç”±å“ªä¸ªsentinelæ¥åšå‘¢ï¼Ÿè¿™æ—¶å€™sentinelä¹‹é—´è¦è¿›è¡Œé€‰ä¸¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](./img/23.png)

åœ¨é€‰ä¸¾çš„æ—¶å€™æ¯ä¸€ä¸ªäººæ‰‹é‡Œéƒ½æœ‰ä¸€ç¥¨ï¼Œè€Œæ¯ä¸€ä¸ªäººçš„åˆéƒ½æƒ³å½“è¿™ä¸ªå¤„ç†äº‹æ•…çš„äººï¼Œé‚£æ€ä¹ˆåŠï¼Ÿå¤§å®¶å°±å¼€å§‹æŠ¢ï¼Œäºæ˜¯æ¯ä¸ªäººéƒ½ä¼šå‘å‡ºä¸€ä¸ªæŒ‡ä»¤ï¼Œåœ¨å†…ç½‘é‡Œè¾¹å‘Šè¯‰å¤§å®¶æˆ‘è¦å½“é€‰ä¸¾äººï¼Œæ¯”å¦‚è¯´ç°åœ¨çš„sentinel1å’Œsentinel4å‘å‡ºè¿™ä¸ªé€‰ä¸¾æŒ‡ä»¤äº†ï¼Œé‚£ä¹ˆsentinel2æ—¢èƒ½æ¥åˆ°sentinel1çš„ä¹Ÿèƒ½æ¥åˆ°sentinel4çš„ï¼Œæ¥åˆ°äº†ä»–ä»¬çš„ç”³è¯·ä»¥åå‘¢ï¼Œsentinel2ä»–å°±ä¼šæŠŠä»–çš„ä¸€ç¥¨æŠ•ç»™å…¶ä¸­ä¸€æ–¹ï¼ŒæŠ•ç»™è°å‘¢ï¼Ÿè°å…ˆè¿‡æ¥æˆ‘æŠ•ç»™è°ï¼Œå‡è®¾sentinel1å…ˆè¿‡æ¥ï¼Œæ‰€ä»¥è¿™ä¸ªç¥¨å°±ç»™åˆ°äº†sentinel1ã€‚é‚£ä¹ˆç»™è¿‡å»ä»¥åå‘¢ï¼Œç°åœ¨sentinel1å°±æ‹¿åˆ°äº†ä¸€ç¥¨ï¼ŒæŒ‰ç…§è¿™æ ·çš„ä¸€ç§å½¢å¼ï¼Œæœ€ç»ˆä¼šæœ‰ä¸€ä¸ªé€‰ä¸¾ç»“æœã€‚å¯¹åº”çš„é€‰ä¸¾æœ€ç»ˆå¾—ç¥¨å¤šçš„ï¼Œé‚£è‡ªç„¶å°±æˆä¸ºäº†å¤„ç†äº‹æ•…çš„äººã€‚éœ€è¦æ³¨æ„åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰å¯èƒ½ä¼šå­˜åœ¨å¤±è´¥çš„ç°è±¡ï¼Œå°±æ˜¯ä¸€è½®é€‰ä¸¾å®Œæ²¡æœ‰é€‰å–ï¼Œé‚£å°±ä¼šæ¥ç€è¿›è¡Œç¬¬äºŒè½®ç¬¬ä¸‰è½®ç›´åˆ°å®Œæˆé€‰ä¸¾ã€‚

æ¥ä¸‹æ¥å°±æ˜¯ç”±é€‰ä¸¾èƒœå‡ºçš„sentinelå»ä»slaveä¸­é€‰ä¸€ä¸ªæ–°çš„masterå‡ºæ¥çš„å·¥ä½œï¼Œè¿™ä¸ªæµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

é¦–å…ˆå®ƒæœ‰ä¸€ä¸ªåœ¨æœåŠ¡å™¨åˆ—è¡¨ä¸­æŒ‘é€‰å¤‡é€‰masterçš„åŸåˆ™

- ä¸åœ¨çº¿çš„OUT


- å“åº”æ…¢çš„OUT


- ä¸åŸmasteræ–­å¼€æ—¶é—´ä¹…çš„OUT


- ä¼˜å…ˆåŸåˆ™

  â€‹	ä¼˜å…ˆçº§
  		offset
  		runid

é€‰å‡ºæ–°çš„masterä¹‹åï¼Œå‘é€æŒ‡ä»¤ï¼ˆ sentinel ï¼‰ç»™å…¶ä»–çš„slaveï¼š

- å‘æ–°çš„masterå‘é€slaveof no one


- å‘å…¶ä»–slaveå‘é€slaveof æ–°masterIPç«¯å£



**æ€»ç»“**ï¼šæ•…éšœè½¬ç§»é˜¶æ®µ

1. å‘ç°é—®é¢˜ï¼Œä¸»è§‚ä¸‹çº¿ä¸å®¢è§‚ä¸‹çº¿
2. ç«é€‰è´Ÿè´£äºº
3. ä¼˜é€‰æ–°master
4. æ–°masterä¸Šä»»ï¼Œå…¶ä»–slaveåˆ‡æ¢masterï¼ŒåŸmasterä½œä¸ºslaveæ•…éšœæ¢å¤åè¿æ¥

## 4.é›†ç¾¤cluster

ç°çŠ¶é—®é¢˜ï¼šä¸šåŠ¡å‘å±•è¿‡ç¨‹ä¸­é‡åˆ°çš„å³°å€¼ç“¶é¢ˆ

- redisæä¾›çš„æœåŠ¡OPSå¯ä»¥è¾¾åˆ°10ä¸‡/ç§’ï¼Œå½“å‰ä¸šåŠ¡OPSå·²ç»è¾¾åˆ°10ä¸‡/ç§’
- å†…å­˜å•æœºå®¹é‡è¾¾åˆ°256Gï¼Œå½“å‰ä¸šåŠ¡éœ€æ±‚å†…å­˜å®¹é‡1T
- ä½¿ç”¨é›†ç¾¤çš„æ–¹å¼å¯ä»¥å¿«é€Ÿè§£å†³ä¸Šè¿°é—®é¢˜

### 4.1 é›†ç¾¤ç®€ä»‹

é›†ç¾¤å°±æ˜¯ä½¿ç”¨ç½‘ç»œå°†è‹¥å¹²å°è®¡ç®—æœºè”é€šèµ·æ¥ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„ç®¡ç†æ–¹å¼ï¼Œä½¿å…¶å¯¹å¤–å‘ˆç°å•æœºçš„æœåŠ¡æ•ˆæœ

![](./img/24.png)

**é›†ç¾¤ä½œç”¨ï¼š**

- åˆ†æ•£å•å°æœåŠ¡å™¨çš„è®¿é—®å‹åŠ›ï¼Œå®ç°è´Ÿè½½å‡è¡¡
- åˆ†æ•£å•å°æœåŠ¡å™¨çš„å­˜å‚¨å‹åŠ›ï¼Œå®ç°å¯æ‰©å±•æ€§
- é™ä½å•å°æœåŠ¡å™¨å®•æœºå¸¦æ¥çš„ä¸šåŠ¡ç¾éš¾

![](./img/25.png)



### 4.2 Clusteré›†ç¾¤ç»“æ„è®¾è®¡

**æ•°æ®å­˜å‚¨è®¾è®¡ï¼š**

1. é€šè¿‡ç®—æ³•è®¾è®¡ï¼Œè®¡ç®—å‡ºkeyåº”è¯¥ä¿å­˜çš„ä½ç½®

2. å°†æ‰€æœ‰çš„å­˜å‚¨ç©ºé—´è®¡åˆ’åˆ‡å‰²æˆ16384ä»½ï¼Œæ¯å°ä¸»æœºä¿å­˜ä¸€éƒ¨åˆ†

   æ³¨æ„ï¼šæ¯ä»½ä»£è¡¨çš„æ˜¯ä¸€ä¸ªå­˜å‚¨ç©ºé—´ï¼Œä¸æ˜¯ä¸€ä¸ªkeyçš„ä¿å­˜ç©ºé—´

3. å°†keyæŒ‰ç…§è®¡ç®—å‡ºçš„ç»“æœæ”¾åˆ°å¯¹åº”çš„å­˜å‚¨ç©ºé—´

![](./img/26.png)

é‚£redisçš„é›†ç¾¤æ˜¯å¦‚ä½•å¢å¼ºå¯æ‰©å±•æ€§çš„å‘¢ï¼Ÿè­¬å¦‚æˆ‘ä»¬è¦å¢åŠ ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹

![](./img/27.png)

å½“æˆ‘ä»¬æŸ¥æ‰¾æ•°æ®æ—¶ï¼Œé›†ç¾¤æ˜¯å¦‚ä½•æ“ä½œçš„å‘¢ï¼Ÿ

- å„ä¸ªæ•°æ®åº“ç›¸äº’é€šä¿¡ï¼Œä¿å­˜å„ä¸ªåº“ä¸­æ§½çš„ç¼–å·æ•°æ®
- ä¸€æ¬¡å‘½ä¸­ï¼Œç›´æ¥è¿”å›
- ä¸€æ¬¡æœªå‘½ä¸­ï¼Œå‘ŠçŸ¥å…·ä½“ä½ç½®

![](./img/28.png)

### 4.3 Clusteré›†ç¾¤ç»“æ„æ­å»º

é¦–å…ˆè¦æ˜ç¡®çš„å‡ ä¸ªè¦ç‚¹ï¼š

- é…ç½®æœåŠ¡å™¨ï¼ˆ3ä¸»3ä»ï¼‰
- å»ºç«‹é€šä¿¡ï¼ˆMeetï¼‰
- åˆ†æ§½ï¼ˆSlotï¼‰
- æ­å»ºä¸»ä»ï¼ˆmaster-slaveï¼‰

**Clusteré…ç½®**

- æ˜¯å¦å¯ç”¨clusterï¼ŒåŠ å…¥clusterèŠ‚ç‚¹

```properties
cluster-enabled yes|no
```

- clusteré…ç½®æ–‡ä»¶åï¼Œè¯¥æ–‡ä»¶å±äºè‡ªåŠ¨ç”Ÿæˆï¼Œä»…ç”¨äºå¿«é€ŸæŸ¥æ‰¾æ–‡ä»¶å¹¶æŸ¥è¯¢æ–‡ä»¶å†…å®¹

```properties
cluster-config-file filename
```

- èŠ‚ç‚¹æœåŠ¡å“åº”è¶…æ—¶æ—¶é—´ï¼Œç”¨äºåˆ¤å®šè¯¥èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿æˆ–åˆ‡æ¢ä¸ºä»èŠ‚ç‚¹

```properties
cluster-node-timeout milliseconds
```

- masterè¿æ¥çš„slaveæœ€å°æ•°é‡

```properties
cluster-migration-barrier min_slave_number
```

**ClusterèŠ‚ç‚¹æ“ä½œå‘½ä»¤**

-  æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯

```properties
cluster nodes
```

- æ›´æ”¹slaveæŒ‡å‘æ–°çš„master

```properties
cluster replicate master-id
```

- å‘ç°ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œæ–°å¢master

```properties
cluster meet ip:port
```

- å¿½ç•¥ä¸€ä¸ªæ²¡æœ‰soltçš„èŠ‚ç‚¹

```properties
cluster forget server_id
```

- æ‰‹åŠ¨æ•…éšœè½¬ç§»

```properties
cluster failover
```

**é›†ç¾¤æ“ä½œå‘½ä»¤ï¼š**

- åˆ›å»ºé›†ç¾¤

```properties
redis-cli â€“-cluster create masterhost1:masterport1 masterhost2:masterport2  masterhost3:masterport3 [masterhostn:masterportn â€¦] slavehost1:slaveport1  slavehost2:slaveport2 slavehost3:slaveport3 -â€“cluster-replicas n
```

æ³¨æ„ï¼šmasterä¸slaveçš„æ•°é‡è¦åŒ¹é…ï¼Œä¸€ä¸ªmasterå¯¹åº”nä¸ªslaveï¼Œç”±æœ€åçš„å‚æ•°nå†³å®š

masterä¸slaveçš„åŒ¹é…é¡ºåºä¸ºç¬¬ä¸€ä¸ªmasterä¸å‰nä¸ªslaveåˆ†ä¸ºä¸€ç»„ï¼Œå½¢æˆä¸»ä»ç»“æ„



- æ·»åŠ masteråˆ°å½“å‰é›†ç¾¤ä¸­ï¼Œè¿æ¥æ—¶å¯ä»¥æŒ‡å®šä»»æ„ç°æœ‰èŠ‚ç‚¹åœ°å€ä¸ç«¯å£

```properties
redis-cli --cluster add-node new-master-host:new-master-port now-host:now-port
```

- æ·»åŠ slave

```properties
redis-cli --cluster add-node new-slave-host:new-slave-port master-host:master-port --cluster-slave --cluster-master-id masterid
```

- åˆ é™¤èŠ‚ç‚¹ï¼Œå¦‚æœåˆ é™¤çš„èŠ‚ç‚¹æ˜¯masterï¼Œå¿…é¡»ä¿éšœå…¶ä¸­æ²¡æœ‰æ§½slot

```properties
redis-cli --cluster del-node del-slave-host:del-slave-port del-slave-id
```

- é‡æ–°åˆ†æ§½ï¼Œåˆ†æ§½æ˜¯ä»å…·æœ‰æ§½çš„masterä¸­åˆ’åˆ†ä¸€éƒ¨åˆ†ç»™å…¶ä»–masterï¼Œè¿‡ç¨‹ä¸­ä¸åˆ›å»ºæ–°çš„æ§½

```properties
redis-cli --cluster reshard new-master-host:new-master:port --cluster-from src-  master-id1, src-master-id2, src-master-idn --cluster-to target-master-id --  cluster-slots slots
```

æ³¨æ„ï¼šå°†éœ€è¦å‚ä¸åˆ†æ§½çš„æ‰€æœ‰masteridä¸åˆ†å…ˆåé¡ºåºæ·»åŠ åˆ°å‚æ•°ä¸­ï¼Œä½¿ç”¨ï¼Œåˆ†éš”

æŒ‡å®šç›®æ ‡å¾—åˆ°çš„æ§½çš„æ•°é‡ï¼Œæ‰€æœ‰çš„æ§½å°†å¹³å‡ä»æ¯ä¸ªæ¥æºçš„masterå¤„è·å–

- é‡æ–°åˆ†é…æ§½ï¼Œä»å…·æœ‰æ§½çš„masterä¸­åˆ†é…æŒ‡å®šæ•°é‡çš„æ§½åˆ°å¦ä¸€ä¸ªmasterä¸­ï¼Œå¸¸ç”¨äºæ¸…ç©ºæŒ‡å®šmasterä¸­çš„æ§½

```properties
redis-cli --cluster reshard src-master-host:src-master-port --cluster-from src-  master-id --cluster-to target-master-id --cluster-slots slots --cluster-yes
```

## 5.ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆ

### 5.1 ç¼“å­˜é¢„çƒ­

**åœºæ™¯**ï¼šâ€œå®•æœºâ€

æœåŠ¡å™¨å¯åŠ¨åè¿…é€Ÿå®•æœº

**é—®é¢˜æ’æŸ¥**ï¼š

1.è¯·æ±‚æ•°é‡è¾ƒé«˜ï¼Œå¤§é‡çš„è¯·æ±‚è¿‡æ¥ä¹‹åéƒ½éœ€è¦å»ä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œä½†æ˜¯ç¼“å­˜ä¸­åˆæ²¡æœ‰ï¼Œæ­¤æ—¶ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•°æ®ç„¶åå°†æ•°æ®å†å­˜å…¥ç¼“å­˜ï¼Œé€ æˆäº†çŸ­æœŸå†…å¯¹redisçš„é«˜å¼ºåº¦æ“ä½œä»è€Œå¯¼è‡´é—®é¢˜

2.ä¸»ä»ä¹‹é—´æ•°æ®ååé‡è¾ƒå¤§ï¼Œæ•°æ®åŒæ­¥æ“ä½œé¢‘åº¦è¾ƒé«˜

**è§£å†³æ–¹æ¡ˆï¼š**

- å‰ç½®å‡†å¤‡å·¥ä½œï¼š

1.æ—¥å¸¸ä¾‹è¡Œç»Ÿè®¡æ•°æ®è®¿é—®è®°å½•ï¼Œç»Ÿè®¡è®¿é—®é¢‘åº¦è¾ƒé«˜çš„çƒ­ç‚¹æ•°æ®

2.åˆ©ç”¨LRUæ•°æ®åˆ é™¤ç­–ç•¥ï¼Œæ„å»ºæ•°æ®ç•™å­˜é˜Ÿåˆ—ä¾‹å¦‚ï¼šstormä¸kafkaé…åˆ

- å‡†å¤‡å·¥ä½œï¼š

1.å°†ç»Ÿè®¡ç»“æœä¸­çš„æ•°æ®åˆ†ç±»ï¼Œæ ¹æ®çº§åˆ«ï¼Œredisä¼˜å…ˆåŠ è½½çº§åˆ«è¾ƒé«˜çš„çƒ­ç‚¹æ•°æ®

2.åˆ©ç”¨åˆ†å¸ƒå¼å¤šæœåŠ¡å™¨åŒæ—¶è¿›è¡Œæ•°æ®è¯»å–ï¼Œæé€Ÿæ•°æ®åŠ è½½è¿‡ç¨‹

3.çƒ­ç‚¹æ•°æ®ä¸»ä»åŒæ—¶é¢„çƒ­

- å®æ–½ï¼š

4.ä½¿ç”¨è„šæœ¬ç¨‹åºå›ºå®šè§¦å‘æ•°æ®é¢„çƒ­è¿‡ç¨‹

5.å¦‚æœæ¡ä»¶å…è®¸ï¼Œä½¿ç”¨äº†CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰ï¼Œæ•ˆæœä¼šæ›´å¥½



**æ€»çš„æ¥è¯´**ï¼šç¼“å­˜é¢„çƒ­å°±æ˜¯ç³»ç»Ÿå¯åŠ¨å‰ï¼Œæå‰å°†ç›¸å…³çš„ç¼“å­˜æ•°æ®ç›´æ¥åŠ è½½åˆ°ç¼“å­˜ç³»ç»Ÿã€‚é¿å…åœ¨ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå†å°†æ•°æ®ç¼“å­˜çš„é—®é¢˜ï¼ç”¨æˆ·ç›´æ¥æŸ¥è¯¢äº‹å…ˆè¢«é¢„çƒ­çš„ç¼“å­˜æ•°æ®ï¼

### 5.2 ç¼“å­˜é›ªå´©

**åœºæ™¯**ï¼šæ•°æ®åº“æœåŠ¡å™¨å´©æºƒï¼Œä¸€è¿ä¸²çš„åœºæ™¯ä¼šéšä¹‹å„¿æ¥

1.ç³»ç»Ÿå¹³ç¨³è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¿½ç„¶æ•°æ®åº“è¿æ¥é‡æ¿€å¢

2.åº”ç”¨æœåŠ¡å™¨æ— æ³•åŠæ—¶å¤„ç†è¯·æ±‚

3.å¤§é‡408ï¼Œ500é”™è¯¯é¡µé¢å‡ºç°

4.å®¢æˆ·åå¤åˆ·æ–°é¡µé¢è·å–æ•°æ®

5.æ•°æ®åº“å´©æºƒ

6.åº”ç”¨æœåŠ¡å™¨å´©æºƒ

7.é‡å¯åº”ç”¨æœåŠ¡å™¨æ— æ•ˆ

8.RedisæœåŠ¡å™¨å´©æºƒ

9.Redisé›†ç¾¤å´©æºƒ

10.é‡å¯æ•°æ®åº“åå†æ¬¡è¢«ç¬é—´æµé‡æ”¾å€’



**é—®é¢˜æ’æŸ¥**ï¼š

1.åœ¨ä¸€ä¸ªè¾ƒçŸ­çš„æ—¶é—´å†…ï¼Œç¼“å­˜ä¸­è¾ƒå¤šçš„keyé›†ä¸­è¿‡æœŸ

2.æ­¤å‘¨æœŸå†…è¯·æ±‚è®¿é—®è¿‡æœŸçš„æ•°æ®ï¼Œredisæœªå‘½ä¸­ï¼Œrediså‘æ•°æ®åº“è·å–æ•°æ®

3.æ•°æ®åº“åŒæ—¶æ¥æ”¶åˆ°å¤§é‡çš„è¯·æ±‚æ— æ³•åŠæ—¶å¤„ç†

4.Rediså¤§é‡è¯·æ±‚è¢«ç§¯å‹ï¼Œå¼€å§‹å‡ºç°è¶…æ—¶ç°è±¡

5.æ•°æ®åº“æµé‡æ¿€å¢ï¼Œæ•°æ®åº“å´©æºƒ

6.é‡å¯åä»ç„¶é¢å¯¹ç¼“å­˜ä¸­æ— æ•°æ®å¯ç”¨

7.RedisæœåŠ¡å™¨èµ„æºè¢«ä¸¥é‡å ç”¨ï¼ŒRedisæœåŠ¡å™¨å´©æºƒ

8.Redisé›†ç¾¤å‘ˆç°å´©å¡Œï¼Œé›†ç¾¤ç“¦è§£

9.åº”ç”¨æœåŠ¡å™¨æ— æ³•åŠæ—¶å¾—åˆ°æ•°æ®å“åº”è¯·æ±‚ï¼Œæ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ•°é‡è¶Šæ¥è¶Šå¤šï¼Œåº”ç”¨æœåŠ¡å™¨å´©æºƒ

10.åº”ç”¨æœåŠ¡å™¨ï¼Œredisï¼Œæ•°æ®åº“å…¨éƒ¨é‡å¯ï¼Œæ•ˆæœä¸ç†æƒ³



æ€»è€Œè¨€ä¹‹å°±ä¸¤ç‚¹ï¼šçŸ­æ—¶é—´èŒƒå›´å†…ï¼Œå¤§é‡keyé›†ä¸­è¿‡æœŸ



**è§£å†³æ–¹æ¡ˆ**

- æ€è·¯ï¼š

1.æ›´å¤šçš„é¡µé¢é™æ€åŒ–å¤„ç†

2.æ„å»ºå¤šçº§ç¼“å­˜æ¶æ„

â€‹	Nginxç¼“å­˜+redisç¼“å­˜+ehcacheç¼“å­˜

3.æ£€æµ‹Mysqlä¸¥é‡è€—æ—¶ä¸šåŠ¡è¿›è¡Œä¼˜åŒ–

â€‹	å¯¹æ•°æ®åº“çš„ç“¶é¢ˆæ’æŸ¥ï¼šä¾‹å¦‚è¶…æ—¶æŸ¥è¯¢ã€è€—æ—¶è¾ƒé«˜äº‹åŠ¡ç­‰

4.ç¾éš¾é¢„è­¦æœºåˆ¶

â€‹	ç›‘æ§redisæœåŠ¡å™¨æ€§èƒ½æŒ‡æ ‡

â€‹		CPUå ç”¨ã€CPUä½¿ç”¨ç‡

â€‹		å†…å­˜å®¹é‡

â€‹		æŸ¥è¯¢å¹³å‡å“åº”æ—¶é—´

â€‹		çº¿ç¨‹æ•°

5.é™æµã€é™çº§

çŸ­æ—¶é—´èŒƒå›´å†…ç‰ºç‰²ä¸€äº›å®¢æˆ·ä½“éªŒï¼Œé™åˆ¶ä¸€éƒ¨åˆ†è¯·æ±‚è®¿é—®ï¼Œé™ä½åº”ç”¨æœåŠ¡å™¨å‹åŠ›ï¼Œå¾…ä¸šåŠ¡ä½é€Ÿè¿è½¬åå†é€æ­¥æ”¾å¼€è®¿é—®

- è½åœ°å®è·µï¼š

1.LRUä¸LFUåˆ‡æ¢

2.æ•°æ®æœ‰æ•ˆæœŸç­–ç•¥è°ƒæ•´

â€‹	æ ¹æ®ä¸šåŠ¡æ•°æ®æœ‰æ•ˆæœŸè¿›è¡Œåˆ†ç±»é”™å³°ï¼ŒAç±»90åˆ†é’Ÿï¼ŒBç±»80åˆ†é’Ÿï¼ŒCç±»70åˆ†é’Ÿ

â€‹	è¿‡æœŸæ—¶é—´ä½¿ç”¨å›ºå®šæ—¶é—´+éšæœºå€¼çš„å½¢å¼ï¼Œç¨€é‡Šé›†ä¸­åˆ°æœŸçš„keyçš„æ•°é‡

3.è¶…çƒ­æ•°æ®ä½¿ç”¨æ°¸ä¹…key

4.å®šæœŸç»´æŠ¤ï¼ˆè‡ªåŠ¨+äººå·¥ï¼‰

â€‹	å¯¹å³å°†è¿‡æœŸæ•°æ®åšè®¿é—®é‡åˆ†æï¼Œç¡®è®¤æ˜¯å¦å»¶æ—¶ï¼Œé…åˆè®¿é—®é‡ç»Ÿè®¡ï¼Œåšçƒ­ç‚¹æ•°æ®çš„å»¶æ—¶

5.åŠ é”ï¼šæ…ç”¨ï¼



**æ€»çš„æ¥è¯´**ï¼šç¼“å­˜é›ªå´©å°±æ˜¯ç¬é—´è¿‡æœŸæ•°æ®é‡å¤ªå¤§ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚å¦‚èƒ½å¤Ÿæœ‰æ•ˆé¿å…è¿‡æœŸæ—¶é—´é›†ä¸­ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³é›ªå´©ç°è±¡çš„ å‡ºç°ï¼ˆçº¦40%ï¼‰ï¼Œé…åˆå…¶ä»–ç­–ç•¥ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ç›‘æ§æœåŠ¡å™¨çš„è¿è¡Œæ•°æ®ï¼Œæ ¹æ®è¿è¡Œè®°å½•åšå¿«é€Ÿè°ƒæ•´ã€‚

### 5.3 ç¼“å­˜å‡»ç©¿

**åœºæ™¯**ï¼šè¿˜æ˜¯æ•°æ®åº“æœåŠ¡å™¨å´©æºƒï¼Œä½†æ˜¯è·Ÿä¹‹å‰çš„åœºæ™¯æœ‰ç‚¹ä¸å¤ªä¸€æ ·

1.ç³»ç»Ÿå¹³ç¨³è¿è¡Œè¿‡ç¨‹ä¸­

2.æ•°æ®åº“è¿æ¥é‡ç¬é—´æ¿€å¢

3.RedisæœåŠ¡å™¨æ— å¤§é‡keyè¿‡æœŸ

4.Rediså†…å­˜å¹³ç¨³ï¼Œæ— æ³¢åŠ¨

5.RedisæœåŠ¡å™¨CPUæ­£å¸¸

6.æ•°æ®åº“å´©æºƒ

**é—®é¢˜æ’æŸ¥ï¼š**

1.Redisä¸­æŸä¸ªkeyè¿‡æœŸï¼Œè¯¥keyè®¿é—®é‡å·¨å¤§

2.å¤šä¸ªæ•°æ®è¯·æ±‚ä»æœåŠ¡å™¨ç›´æ¥å‹åˆ°Redisåï¼Œå‡æœªå‘½ä¸­

3.Redisåœ¨çŸ­æ—¶é—´å†…å‘èµ·äº†å¤§é‡å¯¹æ•°æ®åº“ä¸­åŒä¸€æ•°æ®çš„è®¿é—®



æ€»è€Œè¨€ä¹‹å°±ä¸¤ç‚¹ï¼šå•ä¸ªkeyé«˜çƒ­æ•°æ®ï¼Œkeyè¿‡æœŸ



**è§£å†³æ–¹æ¡ˆ**ï¼š

1.é¢„å…ˆè®¾å®š

â€‹	ä»¥ç”µå•†ä¸ºä¾‹ï¼Œæ¯ä¸ªå•†å®¶æ ¹æ®åº—é“ºç­‰çº§ï¼ŒæŒ‡å®šè‹¥å¹²æ¬¾ä¸»æ‰“å•†å“ï¼Œåœ¨è´­ç‰©èŠ‚æœŸé—´ï¼ŒåŠ å¤§æ­¤ç±»ä¿¡æ¯keyçš„è¿‡æœŸæ—¶é•¿ æ³¨æ„ï¼šè´­ç‰©èŠ‚ä¸ä»…ä»…æŒ‡å½“å¤©ï¼Œä»¥åŠåç»­è‹¥å¹²å¤©ï¼Œè®¿é—®å³°å€¼å‘ˆç°é€æ¸é™ä½çš„è¶‹åŠ¿

2.ç°åœºè°ƒæ•´

â€‹	ç›‘æ§è®¿é—®é‡ï¼Œå¯¹è‡ªç„¶æµé‡æ¿€å¢çš„æ•°æ®å»¶é•¿è¿‡æœŸæ—¶é—´æˆ–è®¾ç½®ä¸ºæ°¸ä¹…æ€§key

3.åå°åˆ·æ–°æ•°æ®

â€‹	å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œé«˜å³°æœŸæ¥ä¸´ä¹‹å‰ï¼Œåˆ·æ–°æ•°æ®æœ‰æ•ˆæœŸï¼Œç¡®ä¿ä¸ä¸¢å¤±

4.äºŒçº§ç¼“å­˜

â€‹	è®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´ï¼Œä¿éšœä¸ä¼šè¢«åŒæ—¶æ·˜æ±°å°±è¡Œ

5.åŠ é”

â€‹	åˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢è¢«å‡»ç©¿ï¼Œä½†æ˜¯è¦æ³¨æ„ä¹Ÿæ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œæ…é‡ï¼



**æ€»çš„æ¥è¯´**ï¼šç¼“å­˜å‡»ç©¿å°±æ˜¯å•ä¸ªé«˜çƒ­æ•°æ®è¿‡æœŸçš„ç¬é—´ï¼Œæ•°æ®è®¿é—®é‡è¾ƒå¤§ï¼Œæœªå‘½ä¸­redisåï¼Œå‘èµ·äº†å¤§é‡å¯¹åŒä¸€æ•°æ®çš„æ•°æ®åº“è®¿é—®ï¼Œå¯¼è‡´å¯¹æ•° æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚åº”å¯¹ç­–ç•¥åº”è¯¥åœ¨ä¸šåŠ¡æ•°æ®åˆ†æä¸é¢„é˜²æ–¹é¢è¿›è¡Œï¼Œé…åˆè¿è¡Œç›‘æ§æµ‹è¯•ä¸å³æ—¶è°ƒæ•´ç­–ç•¥ï¼Œæ¯•ç«Ÿå•ä¸ªkeyçš„è¿‡ æœŸç›‘æ§éš¾åº¦è¾ƒé«˜ï¼Œé…åˆé›ªå´©å¤„ç†ç­–ç•¥å³å¯ã€‚

### 5.4 ç¼“å­˜ç©¿é€

**åœºæ™¯**ï¼šæ•°æ®åº“æœåŠ¡å™¨åˆå´©æºƒäº†ï¼Œè·Ÿä¹‹å‰çš„ä¸€æ ·å—ï¼Ÿ

1.ç³»ç»Ÿå¹³ç¨³è¿è¡Œè¿‡ç¨‹ä¸­

2.åº”ç”¨æœåŠ¡å™¨æµé‡éšæ—¶é—´å¢é‡è¾ƒå¤§

3.RedisæœåŠ¡å™¨å‘½ä¸­ç‡éšæ—¶é—´é€æ­¥é™ä½

4.Rediså†…å­˜å¹³ç¨³ï¼Œå†…å­˜æ— å‹åŠ›

5.RedisæœåŠ¡å™¨CPUå ç”¨æ¿€å¢

6.æ•°æ®åº“æœåŠ¡å™¨å‹åŠ›æ¿€å¢

7.æ•°æ®åº“å´©æºƒ



**é—®é¢˜æ’æŸ¥ï¼š**

1.Redisä¸­å¤§é¢ç§¯å‡ºç°æœªå‘½ä¸­

2.å‡ºç°éæ­£å¸¸URLè®¿é—®



**é—®é¢˜åˆ†æ**ï¼š

- è·å–çš„æ•°æ®åœ¨æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œæ•°æ®åº“æŸ¥è¯¢æœªå¾—åˆ°å¯¹åº”æ•°æ®
- Redisè·å–åˆ°nullæ•°æ®æœªè¿›è¡ŒæŒä¹…åŒ–ï¼Œç›´æ¥è¿”å›
- ä¸‹æ¬¡æ­¤ç±»æ•°æ®åˆ°è¾¾é‡å¤ä¸Šè¿°è¿‡ç¨‹
- å‡ºç°é»‘å®¢æ”»å‡»æœåŠ¡å™¨

**è§£å†³æ–¹æ¡ˆ**ï¼š

1.ç¼“å­˜null

â€‹	å¯¹æŸ¥è¯¢ç»“æœä¸ºnullçš„æ•°æ®è¿›è¡Œç¼“å­˜ï¼ˆé•¿æœŸä½¿ç”¨ï¼Œå®šæœŸæ¸…ç†ï¼‰ï¼Œè®¾å®šçŸ­æ—¶é™ï¼Œä¾‹å¦‚30-60ç§’ï¼Œæœ€é«˜5åˆ†é’Ÿ

2.ç™½åå•ç­–ç•¥

â€‹	æå‰é¢„çƒ­å„ç§åˆ†ç±»æ•°æ®idå¯¹åº”çš„bitmapsï¼Œidä½œä¸ºbitmapsçš„offsetï¼Œç›¸å½“äºè®¾ç½®äº†æ•°æ®ç™½åå•ã€‚å½“åŠ è½½æ­£å¸¸æ•°æ®æ—¶æ”¾è¡Œï¼ŒåŠ è½½å¼‚å¸¸æ•°æ®æ—¶ç›´æ¥æ‹¦æˆªï¼ˆæ•ˆç‡åä½ï¼‰

â€‹	ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆæœ‰å…³å¸ƒéš†è¿‡æ»¤å™¨çš„å‘½ä¸­é—®é¢˜å¯¹å½“å‰çŠ¶å†µå¯ä»¥å¿½ç•¥ï¼‰

2.å®æ–½ç›‘æ§

â€‹	å®æ—¶ç›‘æ§rediså‘½ä¸­ç‡ï¼ˆä¸šåŠ¡æ­£å¸¸èŒƒå›´æ—¶ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ªæ³¢åŠ¨å€¼ï¼‰ä¸nullæ•°æ®çš„å æ¯”

â€‹		éæ´»åŠ¨æ—¶æ®µæ³¢åŠ¨ï¼šé€šå¸¸æ£€æµ‹3-5å€ï¼Œè¶…è¿‡5å€çº³å…¥é‡ç‚¹æ’æŸ¥å¯¹è±¡

â€‹		æ´»åŠ¨æ—¶æ®µæ³¢åŠ¨ï¼šé€šå¸¸æ£€æµ‹10-50å€ï¼Œè¶…è¿‡50å€çº³å…¥é‡ç‚¹æ’æŸ¥å¯¹è±¡

â€‹	æ ¹æ®å€æ•°ä¸åŒï¼Œå¯åŠ¨ä¸åŒçš„æ’æŸ¥æµç¨‹ã€‚ç„¶åä½¿ç”¨é»‘åå•è¿›è¡Œé˜²æ§ï¼ˆè¿è¥ï¼‰

4.keyåŠ å¯†

â€‹	é—®é¢˜å‡ºç°åï¼Œä¸´æ—¶å¯åŠ¨é˜²ç¾ä¸šåŠ¡keyï¼Œå¯¹keyè¿›è¡Œä¸šåŠ¡å±‚ä¼ è¾“åŠ å¯†æœåŠ¡ï¼Œè®¾å®šæ ¡éªŒç¨‹åºï¼Œè¿‡æ¥çš„keyæ ¡éªŒ

â€‹	ä¾‹å¦‚æ¯å¤©éšæœºåˆ†é…60ä¸ªåŠ å¯†ä¸²ï¼ŒæŒ‘é€‰2åˆ°3ä¸ªï¼Œæ··æ·†åˆ°é¡µé¢æ•°æ®idä¸­ï¼Œå‘ç°è®¿é—®keyä¸æ»¡è¶³è§„åˆ™ï¼Œé©³å›æ•°æ®è®¿é—®



**æ€»çš„æ¥è¯´**ï¼šç¼“å­˜å‡»ç©¿æ˜¯æŒ‡è®¿é—®äº†ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè·³è¿‡äº†åˆæ³•æ•°æ®çš„redisæ•°æ®ç¼“å­˜é˜¶æ®µï¼Œæ¯æ¬¡è®¿é—®æ•°æ®åº“ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚é€šå¸¸æ­¤ç±»æ•°æ®çš„å‡ºç°é‡æ˜¯ä¸€ä¸ªè¾ƒä½çš„å€¼ï¼Œå½“å‡ºç°æ­¤ç±»æƒ…å†µä»¥æ¯’æ”»æ¯’ï¼Œå¹¶åŠæ—¶æŠ¥è­¦ã€‚åº”å¯¹ç­–ç•¥åº”è¯¥åœ¨ä¸´æ—¶é¢„æ¡ˆé˜²èŒƒæ–¹é¢å¤šåšæ–‡ç« ã€‚

æ— è®ºæ˜¯é»‘åå•è¿˜æ˜¯ç™½åå•ï¼Œéƒ½æ˜¯å¯¹æ•´ä½“ç³»ç»Ÿçš„å‹åŠ›ï¼Œè­¦æŠ¥è§£é™¤åå°½å¿«ç§»é™¤ã€‚

### 5.5 æ€§èƒ½æŒ‡æ ‡ç›‘æ§

redisä¸­çš„ç›‘æ§æŒ‡æ ‡å¦‚ä¸‹ï¼š

- æ€§èƒ½æŒ‡æ ‡ï¼šPerformance

>å“åº”è¯·æ±‚çš„å¹³å‡æ—¶é—´:
>
>```properties
>latency
>```
>
>å¹³å‡æ¯ç§’å¤„ç†è¯·æ±‚æ€»æ•°
>
>```properties
>instantaneous_ops_per_sec
>```
>
>ç¼“å­˜æŸ¥è¯¢å‘½ä¸­ç‡ï¼ˆé€šè¿‡æŸ¥è¯¢æ€»æ¬¡æ•°ä¸æŸ¥è¯¢å¾—åˆ°énilæ•°æ®æ€»æ¬¡æ•°è®¡ç®—è€Œæ¥ï¼‰
>
>```properties
>hit_rate(calculated)
>
>```

- å†…å­˜æŒ‡æ ‡ï¼šMemory
>å½“å‰å†…å­˜ä½¿ç”¨é‡
>
>```properties
>used_memory
>```
>
>å†…å­˜ç¢ç‰‡ç‡ï¼ˆå…³ç³»åˆ°æ˜¯å¦è¿›è¡Œç¢ç‰‡æ•´ç†ï¼‰
>
>```properties
>mem_fragmentation_ratio
>```
>
>ä¸ºé¿å…å†…å­˜æº¢å‡ºåˆ é™¤çš„keyçš„æ€»æ•°é‡
>
>```properties
>evicted_keys
>```
>
>åŸºäºé˜»å¡æ“ä½œï¼ˆBLPOPç­‰ï¼‰å½±å“çš„å®¢æˆ·ç«¯æ•°é‡
>
>```properties
>blocked_clients
>```

- åŸºæœ¬æ´»åŠ¨æŒ‡æ ‡ï¼šBasic_activity

>å½“å‰å®¢æˆ·ç«¯è¿æ¥æ€»æ•°
>
>```properties
>connected_clients
>```
>
>å½“å‰è¿æ¥slaveæ€»æ•°
>
>```properties
>connected_slaves
>```
>
>æœ€åä¸€æ¬¡ä¸»ä»ä¿¡æ¯äº¤æ¢è·ç°åœ¨çš„ç§’
>
>```properties
>master_last_io_seconds_ago
>```
>
>keyçš„æ€»æ•°
>
>```properties
>keyspace
>```

- æŒä¹…æ€§æŒ‡æ ‡ï¼šPersistence

>å½“å‰æœåŠ¡å™¨æœ€åä¸€æ¬¡RDBæŒä¹…åŒ–çš„æ—¶é—´
>
>```properties
>rdb_last_save_time
>```
>
>å½“å‰æœåŠ¡å™¨æœ€åä¸€æ¬¡RDBæŒä¹…åŒ–åæ•°æ®å˜åŒ–æ€»é‡
>
>```properties
>rdb_changes_since_last_save
>```



- é”™è¯¯æŒ‡æ ‡ï¼šError

>è¢«æ‹’ç»è¿æ¥çš„å®¢æˆ·ç«¯æ€»æ•°ï¼ˆåŸºäºè¾¾åˆ°æœ€å¤§è¿æ¥å€¼çš„å› ç´ ï¼‰
>
>```properties
>rejected_connections
>```
>
>keyæœªå‘½ä¸­çš„æ€»æ¬¡æ•°
>
>```properties
>keyspace_misses
>```
>
>ä¸»ä»æ–­å¼€çš„ç§’æ•°
>
>```properties
>master_link_down_since_seconds
>```





è¦å¯¹redisçš„ç›¸å…³æŒ‡æ ‡è¿›è¡Œç›‘æ§ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€äº›ç”¨å…·ï¼š

- CloudInsight Redis
- Prometheus
- Redis-stat
- Redis-faina
- RedisLive
- zabbix

ä¹Ÿæœ‰ä¸€äº›å‘½ä»¤å·¥å…·ï¼š

- benchmark

>æµ‹è¯•å½“å‰æœåŠ¡å™¨çš„å¹¶å‘æ€§èƒ½
>
>```properties
>redis-benchmark [-h ] [-p ] [-c ] [-n <requests]> [-k ]
>```
>
>èŒƒä¾‹1ï¼š50ä¸ªè¿æ¥ï¼Œ10000æ¬¡è¯·æ±‚å¯¹åº”çš„æ€§èƒ½
>
>```properties
>redis-benchmark
>```
>
>èŒƒä¾‹2ï¼š100ä¸ªè¿æ¥ï¼Œ5000æ¬¡è¯·æ±‚å¯¹åº”çš„æ€§èƒ½
>
>```properties
>redis-benchmark -c 100 -n 5000
>```
>
>![](./img/29.png)

- redis-cli

  â€‹	monitorï¼šå¯åŠ¨æœåŠ¡å™¨è°ƒè¯•ä¿¡æ¯

>```properties
>monitor
>```

  	slowlogï¼šæ…¢æ—¥å¿—

>è·å–æ…¢æŸ¥è¯¢æ—¥å¿—
>
>```properties
>slowlog [operator]
>```
>
>â€‹	get ï¼šè·å–æ…¢æŸ¥è¯¢æ—¥å¿—ä¿¡æ¯
>
>â€‹	len ï¼šè·å–æ…¢æŸ¥è¯¢æ—¥å¿—æ¡ç›®æ•°
>
>â€‹	reset ï¼šé‡ç½®æ…¢æŸ¥è¯¢æ—¥å¿—
>
>ç›¸å…³é…ç½®
>
>```properties
>slowlog-log-slower-than 1000 #è®¾ç½®æ…¢æŸ¥è¯¢çš„æ—¶é—´ä¸‹çº¿ï¼Œå•ä½ï¼šå¾®å¦™
>slowlog-max-len 100	#è®¾ç½®æ…¢æŸ¥è¯¢å‘½ä»¤å¯¹åº”çš„æ—¥å¿—æ˜¾ç¤ºé•¿åº¦ï¼Œå•ä½ï¼šå‘½ä»¤æ•°
>```

